<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>表編集ツール</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 10px; }
    h3 { margin: 20px 0 10px; font-weight: normal; }
    table { border-collapse: collapse; margin-bottom: 20px; }
    td, th { border: 1px solid #333; padding: 5px 10px; min-width: 80px; text-align: center; }
    td[contenteditable="true"], h1[contenteditable="true"], h3[contenteditable="true"] {
      background: #fdfdfd;
    }
    button { margin: 5px; }
  </style>
</head>
<body>
  <h1 contenteditable="true">メインタイトル</h1>

  <h3 contenteditable="true">サブタイトル1</h3>
  <table id="table1">
    <tbody>
      <tr><td contenteditable="true">企業名1</td><td contenteditable="true">123</td></tr>
      <tr><td contenteditable="true">企業名2</td><td contenteditable="true">456</td></tr>
    </tbody>
  </table>

  <h3 contenteditable="true">サブタイトル2</h3>
  <table id="table2">
    <tbody>
      <tr><td contenteditable="true">データ1</td><td contenteditable="true">789</td></tr>
      <tr><td contenteditable="true">データ2</td><td contenteditable="true">012</td></tr>
    </tbody>
  </table>

  <div>
    <button onclick="addRow('table1')">表1 行を追加</button>
    <button onclick="addCol('table1')">表1 列を追加</button>
    <button onclick="addRow('table2')">表2 行を追加</button>
    <button onclick="addCol('table2')">表2 列を追加</button>
  </div>

  <div>
    <button onclick="exportCSV()">CSV保存</button>
    <input type="file" id="csvFile" accept=".csv" onchange="importCSV(event)">
  </div>

<script>
function addRow(tableId) {
  const table = document.getElementById(tableId).querySelector("tbody");
  const cols = table.rows[0] ? table.rows[0].cells.length : 1;
  const newRow = table.insertRow();
  for (let i = 0; i < cols; i++) {
    const cell = newRow.insertCell();
    cell.contentEditable = "true";
    cell.textContent = "";
  }
}

function addCol(tableId) {
  const table = document.getElementById(tableId).querySelector("tbody");
  for (let row of table.rows) {
    const cell = row.insertCell();
    cell.contentEditable = "true";
    cell.textContent = "";
  }
}

function exportCSV() {
  let csv = "";
  // メインタイトル
  csv += document.querySelector("h1").textContent + "\n\n";
  // サブタイトルと表1
  csv += document.querySelectorAll("h3")[0].textContent + "\n";
  csv += tableToCSV(document.getElementById("table1")) + "\n\n";
  // サブタイトルと表2
  csv += document.querySelectorAll("h3")[1].textContent + "\n";
  csv += tableToCSV(document.getElementById("table2")) + "\n";

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "data.csv";
  a.click();
}

function tableToCSV(table) {
  let rows = table.querySelectorAll("tr");
  return Array.from(rows).map(row => 
    Array.from(row.cells).map(cell => `"${cell.textContent}"`).join(",")
  ).join("\n");
}

function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
    let idx = 0;

    // メインタイトル
    document.querySelector("h1").textContent = lines[idx++] || "";
    // サブタイトル1
    document.querySelectorAll("h3")[0].textContent = lines[idx++] || "";
    // 表1
    idx = fillTable(document.getElementById("table1"), lines, idx);
    // サブタイトル2
    document.querySelectorAll("h3")[1].textContent = lines[idx++] || "";
    // 表2
    fillTable(document.getElementById("table2"), lines, idx);
  };
  reader.readAsText(file);
}

function fillTable(table, lines, idx) {
  const tbody = table.querySelector("tbody");
  tbody.innerHTML = ""; // 初期構造は維持しつつ中身リセット
  while (idx < lines.length && lines[idx].includes(",")) {
    const row = tbody.insertRow();
    const values = lines[idx].split(",").map(v => v.replace(/^"|"$/g, ""));
    for (let val of values) {
      const cell = row.insertCell();
      cell.contentEditable = "true";
      cell.textContent = val;
    }
    idx++;
  }
  return idx;
}
</script>
</body>
</html>