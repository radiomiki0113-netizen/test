<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å°±è·æ´»å‹• ãƒ¡ãƒ¢</title>
<style>
/* ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³CSS */
:root {
  --primary-color: #007bff;
  --secondary-color: #6c757d;
  --light-bg: #f8f9fa;
  --border-color: #dee2e6;
  
  /* ğŸš© ã‚»ãƒ«ã‚«ãƒ©ãƒ¼ç”¨ã®å®šç¾© */
  --color-yellow: #fff3cd;
  --color-green: #d4edda;
  --color-red: #f8d7da;
}
body { 
  font-family: 'Helvetica Neue', Arial, sans-serif; 
  padding: 30px; 
  background-color: var(--light-bg);
  color: #333;
  max-width: 1200px;
  margin: 0 auto;
}
/* ... (H1, H3, TH, Tableã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥ã€å‰å›ã®ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§) ... */

/* ğŸš© TDå…±é€šã‚¹ã‚¿ã‚¤ãƒ« (ä¸­å¤®æƒãˆã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«) */
td {
  border: 1px solid var(--border-color); 
  padding: 0; 
  height: 60px; 
  white-space: normal;
  word-wrap: break-word;
  position: relative; 
  text-align: center; 
  vertical-align: middle; 
  box-sizing: border-box;
  cursor: pointer; 
  
  display: flex;
  justify-content: center; 
  align-items: center; 
  transition: background-color 0.2s, box-shadow 0.1s;
}

/* ğŸš© ã‚»ãƒ«é¸æŠæ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
td.selected-cell {
    box-shadow: 0 0 0 3px var(--primary-color) inset;
    border-color: var(--primary-color);
}
/* ... (cell-content-wrapper, cell-input, button-groupãªã©ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥) ... */
</style>
</head>
<body>

<h1 ondblclick="makeEditableH3(this)">å°±è·æ´»å‹• ãƒ¡ãƒ¢</h1>
<br>

<h3 ondblclick="makeEditableH3(this)">å‹•ã„ã¦ã„ã‚‹ä¼æ¥­ (ä¸­å¤®æƒãˆé …ç›®ã®ã¿)</h3>
<table id="table1">
  <thead>
    <tr>
      <th contenteditable="true">æ¥­ç¨®</th>
      <th contenteditable="true">é¸è€ƒçŠ¶æ³</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td> 
      <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td>
    </tr>
  </tbody>
</table>

<div class="button-group table-controls">
  <button onclick="addRow('table1')">è¡Œè¿½åŠ </button>
  <button onclick="removeRow('table1')" class="secondary-btn">è¡Œå‰Šé™¤</button>
  <button onclick="addCol('table1')">åˆ—è¿½åŠ </button>
  <button onclick="removeCol('table1')" class="secondary-btn">åˆ—å‰Šé™¤</button>
</div>

<h3 ondblclick="makeEditableH3(this)">æƒ…å ±åé›†ä¸­ã®ä¼æ¥­ (ä¸­å¤®æƒãˆé …ç›®ã®ã¿)</h3>
<table id="table2">
  <thead>
    <tr>
      <th contenteditable="true">èˆˆå‘³åº¦</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td>
    </tr>
  </tbody>
</table>

<div class="button-group table-controls">
  <button onclick="addRow('table2')">è¡Œè¿½åŠ </button>
  <button onclick="removeRow('table2')" class="secondary-btn">è¡Œå‰Šé™¤</button>
  <button onclick="addCol('table2')">åˆ—è¿½åŠ </button>
  <button onclick="removeCol('table2')" class="secondary-btn">åˆ—å‰Šé™¤</button>
</div>

<div class="button-group global-controls">
  <span>**ã‚»ãƒ«ã«è‰²ã‚’ä»˜ã‘ã‚‹:**</span>
  <button class="color-btn color-btn-yellow" onclick="applyColor('var(--color-yellow)')" title="ã‚¤ã‚¨ãƒ­ãƒ¼"></button>
  <button class="color-btn color-btn-green" onclick="applyColor('var(--color-green)')" title="ã‚°ãƒªãƒ¼ãƒ³"></button>
  <button class="color-btn color-btn-red" onclick="applyColor('var(--color-red)')" title="ãƒ¬ãƒƒãƒ‰"></button>
  <button onclick="applyColor('')" class="secondary-btn">è‰²ã‚’ã‚¯ãƒªã‚¢</button>
  
  <hr style="width: 100%; border: none; border-bottom: 1px dashed #ccc; margin: 10px 0;">

  <button onclick="saveTables()">ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (ãƒ–ãƒ©ã‚¦ã‚¶)</button>
  <button onclick="exportCSV()" class="secondary-btn">CSVã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button onclick="document.getElementById('csvFileInput').click()" class="secondary-btn">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  <button onclick="resetTables()">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
  <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="importCSV(event)">
</div>

<script>
// Local Storage å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆã‚³ãƒ¼ãƒ‰ 
// if (localStorage.getItem('tableData')) {
//     localStorage.removeItem('tableData');
//     console.log("Local Storage data has been cleared."); 
// }

let selectedCell = null;

// ------------------------------------
// ğŸš© ã‚»ãƒ«é¸æŠã¨è‰²å¤‰æ›´
// ------------------------------------

function selectCell(cell) {
    if (selectedCell) {
        selectedCell.classList.remove('selected-cell');
    }
    
    if (selectedCell !== cell) {
        cell.classList.add('selected-cell');
        selectedCell = cell;
    } else {
        selectedCell = null;
    }
}

function applyColor(colorVariable) {
    if (!selectedCell) {
        alert("è‰²ã‚’å¤‰æ›´ã—ãŸã„ã‚»ãƒ«ã‚’ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
    }
    
    const color = colorVariable ? getComputedStyle(document.documentElement).getPropertyValue(colorVariable.replace('var(', '').replace(')', '')) : '';
    
    selectedCell.style.backgroundColor = color;
    
    selectedCell.classList.remove('selected-cell');
    selectedCell = null;

    alert(`ã‚»ãƒ«ã®è‰²ã‚’${color === '' ? 'ã‚¯ãƒªã‚¢' : color}ã«è¨­å®šã—ã¾ã—ãŸã€‚å¿˜ã‚Œãšã«ã€Œãƒ‡ãƒ¼ã‚¿ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`);
}

// ------------------------------------
// ğŸš© æ ¸å¿ƒã¨ãªã‚‹ã‚»ãƒ«æ“ä½œé–¢æ•° 
// ------------------------------------
// ... (makeEditableH3, wrapContent, getCellText, setCellText, makeEditable, è£œåŠ©é–¢æ•°ã¯å‰å›ã®ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§) ...

// --- è£œåŠ©é–¢æ•° (å†æ²) ---
function getTableHeadCells(tableId) {
    const table = document.getElementById(tableId);
    if (table && table.tHead && table.tHead.rows.length > 0) {
        return table.tHead.rows[0].cells;
    }
    return [];
}
function getTableBody(tableId) {
    return document.getElementById(tableId).tBodies[0];
}
const decodeCSVLine = (line) => {
  const cells = line.match(/(?:"[^"]*?"|[^,]+)/g) || [];
  return cells.map(c => c.replace(/^"|"$/g,'').replace(/""/g,'"').trim());
};

function makeEditableH3(element) {
    if (element.querySelector('input')) return;
    const originalText = element.innerText;
    element.innerText = '';
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'text-input';
    input.value = originalText;
    input.onblur = function() {
        element.innerText = this.value;
        this.remove();
    };
    input.onkeydown = function(e) {
        if (e.key === 'Enter') {
            this.blur();
        }
    };
    element.appendChild(input);
    input.focus();
}

function wrapContent(cell, text = '') {
    let wrapper = cell.querySelector('.cell-content-wrapper');
    if (!wrapper) { 
        wrapper = document.createElement('div');
        wrapper.className = 'cell-content-wrapper';
        cell.appendChild(wrapper);
    }
    wrapper.innerText = text;
}

function getCellText(cell) {
    const wrapper = cell.querySelector('.cell-content-wrapper');
    return wrapper ? wrapper.innerText : '';
}

function setCellText(cell, text) {
    const wrapper = cell.querySelector('.cell-content-wrapper');
    if (wrapper) {
        wrapper.innerText = text;
        wrapper.style.display = 'inline-block'; 
    } else {
        wrapContent(cell, text);
    }
}

function makeEditable(cell) {
    if (cell.querySelector('input')) return; 
    
    if (selectedCell === cell) {
        cell.classList.remove('selected-cell');
        selectedCell = null;
    }

    const originalText = getCellText(cell);
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-input';
    input.value = originalText;
    
    input.onblur = function() {
        const newText = this.value;
        const parentCell = this.parentElement;
        setCellText(parentCell, newText);
        this.remove(); 
    };

    input.onkeydown = function(e) {
        if (e.key === 'Enter') {
            this.blur();
        }
    };
    
    const wrapper = cell.querySelector('.cell-content-wrapper');
    if(wrapper) wrapper.style.display = 'none';

    cell.appendChild(input);
    input.focus(); 
}


// ------------------------------------
// 1. ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œé–¢æ•° (addRow/addCol/resetTablesã¯å…¨ã¦ä¿®æ­£æ¸ˆã¿)
// ------------------------------------

function addRow(tableId){
  const table = document.getElementById(tableId);
  let tbody = table.tBodies[0];
  if (!tbody) { tbody = table.createTBody(); }

  const headCells = getTableHeadCells(tableId);
  const cols = headCells.length;
  
  if (cols === 0) { alert("å…ˆã«åˆ—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚"); return; }

  const row = tbody.insertRow();
  
  for(let i=0; i<cols; i++){ 
    const cell=row.insertCell(); 
    cell.onclick = function() { selectCell(this); }; // ğŸš© é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ  (OK)
    cell.ondblclick = function() { makeEditable(this); }; 
    wrapContent(cell); 
  }
}

function removeRow(tableId){
  const tbody = getTableBody(tableId);
  if (!tbody) return; 

  if(tbody.rows.length > 1) {
    tbody.deleteRow(-1);
  } else if (tbody.rows.length === 1) {
    Array.from(tbody.rows[0].cells).forEach(cell => {
        setCellText(cell, '');
        cell.style.backgroundColor = ''; 
    });
  }
}

function addCol(tableId){
  const table = document.getElementById(tableId);
  let tbody = table.tBodies[0];
  if (!tbody) { tbody = table.createTBody(); }
  
  let tHeadRow;
  if (table.tHead && table.tHead.rows.length > 0) {
      tHeadRow = table.tHead.rows[0];
  } else {
      if (!table.tHead) table.createTHead();
      tHeadRow = table.tHead.insertRow();
  }
  
  const th = document.createElement('th'); 
  th.innerText = `æ–°è¦é …ç›®`;
  th.contentEditable="true"; 
  tHeadRow.appendChild(th);
  
  for(let row of tbody.rows){ 
    const cell=row.insertCell(); 
    cell.onclick = function() { selectCell(this); }; // ğŸš© é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ  (OK)
    cell.ondblclick = function() { makeEditable(this); }; 
    wrapContent(cell);
  }
  
  if (tbody.rows.length === 0) {
      const row = tbody.insertRow();
      const cell = row.insertCell(); 
      cell.onclick = function() { selectCell(this); }; // ğŸš© é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ  (OK)
      cell.ondblclick = function() { makeEditable(this); }; 
      wrapContent(cell);
  }
}

function removeCol(tableId){
  const table = document.getElementById(tableId);
  const tbody = table.tBodies[0];
  const ths = getTableHeadCells(tableId);
  
  if(ths.length > 1){ 
    ths[ths.length - 1].remove(); 
    if (tbody) {
        for(let row of tbody.rows) {
          if (row.cells.length > 0) {
            row.deleteCell(-1); 
          }
        }
    }
  } else {
      alert("æœ€å¾Œã®åˆ—ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
  }
}


// ------------------------------------
// 2. ãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢æ•° (load/resetã¯å…¨ã¦ä¿®æ­£æ¸ˆã¿)
// ------------------------------------
function resetTables(){
    document.querySelector('h1').innerText = "å°±è·æ´»å‹• ãƒ¡ãƒ¢";
    document.querySelector('h3:nth-of-type(1)').innerText = "å‹•ã„ã¦ã„ã‚‹ä¼æ¥­ (ä¸­å¤®æƒãˆé …ç›®ã®ã¿)";
    document.querySelector('h3:nth-of-type(2)').innerText = "æƒ…å ±åé›†ä¸­ã®ä¼æ¥­ (ä¸­å¤®æƒãˆé …ç›®ã®ã¿)";

    const defaultHeaders = {
        'table1': ['æ¥­ç¨®', 'é¸è€ƒçŠ¶æ³'],
        'table2': ['èˆˆå‘³åº¦']
    };

    ['table1','table2'].forEach(id => {
        const table = document.getElementById(id);
        // ... (THä½œæˆã¯çœç•¥) ...
        let tbody = table.tBodies[0];
        if (!tbody) { tbody = table.createTBody(); }
        tbody.innerHTML = '';
        const row = tbody.insertRow();
        const headerCount = defaultHeaders[id].length;
        for (let i = 0; i < headerCount; i++) {
            const cell = row.insertCell(); 
            cell.onclick = function() { selectCell(this); }; // ğŸš© é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ  (OK)
            cell.ondblclick = function() { makeEditable(this); }; 
            wrapContent(cell); 
        }
    });
    localStorage.removeItem('tableData'); 
}

function saveTables(){
  const data={};
  data['texts']=[document.querySelector('h1').innerText, ...Array.from(document.querySelectorAll('h3')).map(h=>h.innerText)];
  
  ['table1','table2'].forEach((id,index)=>{
    const table=document.getElementById(id);
    const rows=[];
    
    const headerCells = Array.from(getTableHeadCells(id)).map(cell => cell.innerText);
    rows.push(headerCells);

    const tbody = table.tBodies[0];
    if (tbody) {
        for(let row of tbody.rows){
          const cells=[];
          const cellColors=[]; 
          for(let cell of row.cells) {
              cells.push(getCellText(cell)); 
              cellColors.push(cell.style.backgroundColor || ''); 
          }
          rows.push({ data: cells, colors: cellColors }); 
        }
    }
    data['table'+(index+1)]=rows;
  });
  localStorage.setItem('tableData',JSON.stringify(data));
  alert("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸï¼");
}

window.onload=()=>{
  const saved=localStorage.getItem('tableData');
  
  // ... (H1, H3ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã¯çœç•¥) ...

  if(saved){
    const data=JSON.parse(saved);
    // ... (H1, H3ãƒ†ã‚­ã‚¹ãƒˆå¾©å…ƒã¯çœç•¥) ...
    
    ['table1','table2'].forEach((id,index)=>{
      const table=document.getElementById(id);
      // ... (THå¾©å…ƒã¯çœç•¥) ...
      let tbody = table.tBodies[0];
      if (!tbody) { tbody = table.createTBody(); }
      
      const allRows=data['table'+(index+1)]; 
      const dataRows = allRows.slice(1);
      tbody.innerHTML = '';
      
      dataRows.forEach(rowDataObj => {
          const row = tbody.insertRow();
          rowDataObj.data.forEach((cellVal, i) => { 
              const cell = row.insertCell(); 
              cell.onclick = function() { selectCell(this); }; // ğŸš© é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ  (OK)
              cell.ondblclick = function() { makeEditable(this); }; 

              if (rowDataObj.colors && rowDataObj.colors[i]) {
                  cell.style.backgroundColor = rowDataObj.colors[i];
              }
              
              setCellText(cell, cellVal); 
          });
      });

      if (tbody.rows.length === 0 && headerData.length > 0) {
        const row = tbody.insertRow();
        headerData.forEach(() => { 
            const cell = row.insertCell(); 
            cell.onclick = function() { selectCell(this); }; // ğŸš© é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ  (OK)
            cell.ondblclick = function() { makeEditable(this); }; 
            wrapContent(cell); 
        });
      }
    });
  } else {
    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€åˆæœŸã®<td>ã«ãƒ©ãƒƒãƒ‘ãƒ¼ã¨ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æŒ¿å…¥ (OK)
    document.querySelectorAll('#table1 tbody td, #table2 tbody td').forEach(cell => {
      cell.onclick = function() { selectCell(this); }; 
      wrapContent(cell);
    });
  }
}

// ------------------------------------
// 3. CSVæ“ä½œé–¢æ•° 
// ------------------------------------
// ... (exportCSVã¯çœç•¥) ...

// 4. CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢æ•° 
function importCSV(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  
  reader.onload=e=>{
    // ... (å‰å‡¦ç†ã¯çœç•¥) ...
    
    while(lineIndex < lines.length && tableIndex < 2){
      tableIndex++;
      const table = tables[tableIndex];
      // ... (H3ã€THå¾©å…ƒã¯çœç•¥) ...
      
      const expectedCols = tHeadRow.cells.length;

      while(lineIndex < lines.length && lines[lineIndex]){
        const rowCells = decodeCSVLine(lines[lineIndex]);
        // ... (ç©ºè¡Œ/ã‚¿ã‚¤ãƒˆãƒ«ãƒã‚§ãƒƒã‚¯ã¯çœç•¥) ...

        const row = tbody.insertRow();
        for (let i = 0; i < expectedCols; i++) {
            const cell = row.insertCell(); 
            const cellVal = rowCells[i] ? rowCells[i] : ''; 
            
            cell.onclick = function() { selectCell(this); }; // ğŸš© é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ  (OK)
            cell.ondblclick = function() { makeEditable(this); }; 
            setCellText(cell, cellVal); 
        }
        lineIndex++;
      }
      
      lineIndex++; 
    }
    alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼");
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
