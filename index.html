<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å°±è·æ´»å‹• ãƒ¡ãƒ¢</title>
<style>
/* ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³CSS */
/* ... (ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã¯å‰å›ã®ã‚‚ã®ã¨åŒã˜ã§ã™ã€‚çœç•¥) ... */
:root {
  --primary-color: #007bff;
  --secondary-color: #6c757d;
  --light-bg: #f8f9fa;
  --border-color: #dee2e6;
  --header-bg: #e9ecef;
  
  /* ğŸš© ã‚»ãƒ«ã‚«ãƒ©ãƒ¼ç”¨ã®å®šç¾© */
  --color-yellow: #fff3cd;
  --color-green: #d4edda;
  --color-red: #f8d7da;
}
/* ... (body, h1, table, th, td ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥) ... */
td {
  border: 1px solid var(--border-color); 
  padding: 0; 
  height: 60px; 
  white-space: normal;
  word-wrap: break-word;
  position: relative; 
  text-align: center; 
  vertical-align: middle; 
  box-sizing: border-box;
  cursor: pointer; 
  
  display: flex;
  justify-content: center; 
  align-items: center; 
  transition: background-color 0.2s, box-shadow 0.1s;
}

td.selected-cell {
    box-shadow: 0 0 0 3px var(--primary-color) inset;
    border-color: var(--primary-color);
}
.cell-content-wrapper {
  box-sizing: border-box;
  width: 100%;
  height: 100%; 
  padding: 12px 15px; 
  
  display: inline-block; 
  white-space: pre-wrap !important; 
  text-align: center !important; 
}
.cell-input {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  box-sizing: border-box;
  border: none;
  background-color: #fffacd; 
  padding: 12px 15px;
  font-family: inherit;
  font-size: inherit;
  text-align: center !important; 
  outline: 1px solid var(--primary-color);
  z-index: 20; 
}
/* ... (ãƒœã‚¿ãƒ³ãªã©ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥) ... */
</style>
</head>
<body>

<h1 ondblclick="makeEditableH3(this)">å°±è·æ´»å‹• ãƒ¡ãƒ¢</h1>
<br>

<h3 ondblclick="makeEditableH3(this)">å‹•ã„ã¦ã„ã‚‹ä¼æ¥­ (ä¸­å¤®æƒãˆé …ç›®ã®ã¿)</h3>
<table id="table1">
  <thead>
    <tr>
      <th contenteditable="true">æ¥­ç¨®</th>
      <th contenteditable="true">é¸è€ƒçŠ¶æ³</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td> 
      <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td>
    </tr>
  </tbody>
</table>

<div class="button-group table-controls">
  <button onclick="addRow('table1')">è¡Œè¿½åŠ </button>
  <button onclick="removeRow('table1')" class="secondary-btn">è¡Œå‰Šé™¤</button>
  <button onclick="addCol('table1')">åˆ—è¿½åŠ </button>
  <button onclick="removeCol('table1')" class="secondary-btn">åˆ—å‰Šé™¤</button>
</div>

<h3 ondblclick="makeEditableH3(this)">æƒ…å ±åé›†ä¸­ã®ä¼æ¥­ (ä¸­å¤®æƒãˆé …ç›®ã®ã¿)</h3>
<table id="table2">
  <thead>
    <tr>
      <th contenteditable="true">èˆˆå‘³åº¦</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td>
    </tr>
  </tbody>
</table>

<div class="button-group table-controls">
  <button onclick="addRow('table2')">è¡Œè¿½åŠ </button>
  <button onclick="removeRow('table2')" class="secondary-btn">è¡Œå‰Šé™¤</button>
  <button onclick="addCol('table2')">åˆ—è¿½åŠ </button>
  <button onclick="removeCol('table2')" class="secondary-btn">åˆ—å‰Šé™¤</button>
</div>

<div class="button-group global-controls">
  <span>**ã‚»ãƒ«ã«è‰²ã‚’ä»˜ã‘ã‚‹:**</span>
  <button class="color-btn color-btn-yellow" onclick="applyColor('var(--color-yellow)')" title="ã‚¤ã‚¨ãƒ­ãƒ¼"></button>
  <button class="color-btn color-btn-green" onclick="applyColor('var(--color-green)')" title="ã‚°ãƒªãƒ¼ãƒ³"></button>
  <button class="color-btn color-btn-red" onclick="applyColor('var(--color-red)')" title="ãƒ¬ãƒƒãƒ‰"></button>
  <button onclick="applyColor('')" class="secondary-btn">è‰²ã‚’ã‚¯ãƒªã‚¢</button>
  
  <hr style="width: 100%; border: none; border-bottom: 1px dashed #ccc; margin: 10px 0;">

  <button onclick="saveTables()">ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (ãƒ–ãƒ©ã‚¦ã‚¶)</button>
  <button onclick="exportCSV()" class="secondary-btn">CSVã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button onclick="document.getElementById('csvFileInput').click()" class="secondary-btn">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  <button onclick="resetTables()">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
  <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="importCSV(event)">
</div>

<script>
let selectedCell = null;

// ------------------------------------
// ğŸš© å …ç‰¢åŒ–ã—ãŸ wrapContent é–¢æ•° (æœ€é‡è¦ä¿®æ­£ç®‡æ‰€)
// ------------------------------------

function wrapContent(cell, text = '') {
    let wrapper = cell.querySelector('.cell-content-wrapper');
    
    if (!wrapper) { 
        // ãƒ©ãƒƒãƒ‘ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ä½œæˆ
        wrapper = document.createElement('div');
        wrapper.className = 'cell-content-wrapper';
        
        // â˜…ã‚»ãƒ«ã®æ—¢å­˜ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã®ä¸­ã¸ç§»å‹•
        const existingText = cell.textContent.trim();
        cell.textContent = ''; // ã‚»ãƒ«å†…ã®æ—¢å­˜å†…å®¹ã‚’ã‚¯ãƒªã‚¢ (ã“ã‚Œã§äºŒé‡åŒ–ã‚’é˜²ã)
        
        cell.appendChild(wrapper);
        wrapper.innerText = text || existingText; // æ—¢å­˜ãƒ†ã‚­ã‚¹ãƒˆã‹æ¸¡ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’æ¡ç”¨
    } else {
        // ãƒ©ãƒƒãƒ‘ãƒ¼ãŒæ—¢ã«ã‚ã‚‹å ´åˆã¯ã€ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿æ›´æ–°
        wrapper.innerText = text;
    }
}

function getCellText(cell) {
    const wrapper = cell.querySelector('.cell-content-wrapper');
    return wrapper ? wrapper.innerText : '';
}

function setCellText(cell, text) {
    const wrapper = cell.querySelector('.cell-content-wrapper');
    if (wrapper) {
        wrapper.innerText = text;
        wrapper.style.display = 'inline-block'; 
    } else {
        // ãƒ©ãƒƒãƒ‘ãƒ¼ãŒãªã„å ´åˆã§ã‚‚ã€ã“ã®é–¢æ•°ã¯ãƒ©ãƒƒãƒ—å‡¦ç†ã‚’å‘¼ã³å‡ºã—ã€ç¢ºå®Ÿã«è¡¨ç¤ºã™ã‚‹
        wrapContent(cell, text);
    }
}


// ------------------------------------
// ğŸš© ã‚»ãƒ«é¸æŠã€ãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢æ•° (å‰å›ä¿®æ­£ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šç®‡æ‰€ã¯ç¶­æŒ)
// ------------------------------------

function selectCell(cell) {
    // ç·¨é›†ã‚¤ãƒ³ãƒ—ãƒƒãƒˆãŒã‚ã‚‹å ´åˆã¯é¸æŠã‚’ã‚¹ã‚­ãƒƒãƒ—
    if (cell.querySelector('input.cell-input')) return; 

    if (selectedCell) {
        selectedCell.classList.remove('selected-cell');
    }
    
    if (selectedCell !== cell) {
        cell.classList.add('selected-cell');
        selectedCell = cell;
    } else {
        selectedCell = null;
    }
}

function makeEditable(cell) {
    if (cell.querySelector('input')) return; 
    
    // ç·¨é›†æ™‚ã¯é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
    if (selectedCell === cell) {
        cell.classList.remove('selected-cell');
        selectedCell = null;
    }
    // ... (makeEditableã®æ®‹ã‚Šã®ãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥ - å‰å›ã¨åŒã˜) ...
    const originalText = getCellText(cell);
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-input';
    input.value = originalText;
    
    input.onblur = function() {
        const newText = this.value;
        const parentCell = this.parentElement;
        setCellText(parentCell, newText);
        this.remove(); 
    };

    input.onkeydown = function(e) {
        if (e.key === 'Enter') {
            this.blur();
        }
    };
    
    const wrapper = cell.querySelector('.cell-content-wrapper');
    if(wrapper) wrapper.style.display = 'none';

    cell.appendChild(input);
    input.focus(); 
}

// ... (applyColor, addRow, addCol, removeRow, removeCol, resetTables ã¯å‰å›ã¨ã»ã¼åŒã˜) ...
// ------------------------------------
// 2. ãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢æ•° (window.onloadã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¿½åŠ )
// ------------------------------------
// ... (saveTablesã¯çœç•¥) ...

window.onload=()=>{
  const saved=localStorage.getItem('tableData');
  
  document.querySelector('h1').ondblclick = function() { makeEditableH3(this); };
  document.querySelectorAll('h3').forEach(h => {
    h.ondblclick = function() { makeEditableH3(this); };
  });

  if(saved){
    const data=JSON.parse(saved);
    const texts=[document.querySelector('h1'), ...document.querySelectorAll('h3')];
    data.texts.forEach((txt,i)=>{ 
        if(texts[i]) texts[i].innerText=txt; 
    });
    
    ['table1','table2'].forEach((id,index)=>{
      const table=document.getElementById(id);
      // ... (THã¨tbodyã®ä½œæˆ/å¾©å…ƒã¯çœç•¥) ...
      
      const allRows=data['table'+(index+1)]; 
      const dataRows = allRows.slice(1);
      tbody.innerHTML = '';
      
      dataRows.forEach(rowDataObj => {
          const row = tbody.insertRow();
          rowDataObj.data.forEach((cellVal, i) => { 
              const cell = row.insertCell(); 
              cell.onclick = function() { selectCell(this); }; 
              cell.ondblclick = function() { makeEditable(this); }; 

              if (rowDataObj.colors && rowDataObj.colors[i]) {
                  cell.style.backgroundColor = rowDataObj.colors[i];
              }
              
              setCellText(cell, cellVal); 
          });
      });

      // ... (ç©ºè¡Œä½œæˆãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥) ...
    });
  } 

  // â˜…â˜…â˜… æœ€çµ‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç† â˜…â˜…â˜…
  // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå¾Œã€ã¾ãŸã¯ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸå ´åˆã«ã€ã™ã¹ã¦ã®ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºå®Ÿã«å†è¨­å®šã™ã‚‹
  document.querySelectorAll('#table1 tbody td, #table2 tbody td').forEach(cell => {
      // å¿µã®ãŸã‚HTMLã§è¨­å®šã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã‚‚ä¸Šæ›¸ã
      cell.onclick = function() { selectCell(this); }; 
      cell.ondblclick = function() { makeEditable(this); };
      
      // wrapContentã‚’å‘¼ã³å‡ºã—ã¦ã€ã‚»ãƒ«ã®å†…å®¹ã‚’ãƒ©ãƒƒãƒ‘ãƒ¼å†…ã«ç¢ºå®Ÿã«ç§»å‹•ã•ã›ã‚‹
      wrapContent(cell, getCellText(cell));
  });
}
// ... (CSVé–¢é€£ã®é–¢æ•°ã¯çœç•¥) ...
</script>
</body>
</html>
