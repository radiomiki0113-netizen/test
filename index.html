<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>就職活動 メモ</title>
<style>
/* 🎨 デザインCSS (変更なし) */
:root {
  --primary-color: #007bff;
  --secondary-color: #6c757d;
  --light-bg: #f8f9fa;
  --border-color: #dee2e6;
  --header-bg: #e9ecef;
}
body { 
  font-family: 'Helvetica Neue', Arial, sans-serif; 
  padding: 30px; 
  background-color: var(--light-bg);
  color: #333;
  max-width: 1200px;
  margin: 0 auto;
}
h1 { 
  font-size: 28px; 
  border-bottom: 3px solid var(--primary-color);
  padding-bottom: 10px;
  margin-bottom: 30px;
  color: #212529;
  cursor: text;
}
h3 { 
  font-size: 20px; 
  margin-top: 30px; 
  margin-bottom: 15px; 
  font-weight: 600;
  color: var(--primary-color);
  cursor: text;
}
table { 
  border-collapse: collapse; 
  margin-bottom: 25px; 
  width: 100%; 
  table-layout: fixed; 
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
  background-color: white;
}
th, td { 
  border: 1px solid var(--border-color); 
  padding: 12px 15px; 
  text-align: left; 
  white-space: normal;
  word-wrap: break-word;
  vertical-align: top;
}
th {
  background-color: var(--header-bg); 
  font-weight: bold;
  color: #495057;
  position: sticky; 
  top: 0;
  z-index: 10;
}
td[contenteditable="true"]:focus {
  background-color: #fffacd; 
  outline: 1px solid var(--primary-color);
}

.button-group {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.table-controls {
    border: 1px solid var(--border-color);
    padding: 10px;
    border-radius: 5px;
    background-color: white;
}
.global-controls {
    margin-top: 20px;
    padding: 10px 0;
}
button {
  background-color: var(--primary-color);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s;
  font-weight: 500;
}
button:hover {
  background-color: #0056b3;
}
button:active {
  transform: scale(0.98);
}
.secondary-btn {
  background-color: var(--secondary-color);
}
.secondary-btn:hover {
  background-color: #5a6268;
}
</style>
</head>
<body>

<h1 contenteditable="true">就職活動 メモ</h1>
<br>

<h3 contenteditable="true">動いている企業</h3>
<table id="table1">
  <thead>
    <tr>
      <th contenteditable="true">企業名</th>
      <th contenteditable="true">業種</th>
      <th contenteditable="true">選考状況</th>
      <th contenteditable="true">次回予定</th>
    </tr>
  </thead>
  <tbody>
    <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
  </tbody>
</table>

<div class="button-group table-controls">
  <button onclick="addRow('table1')">行追加</button>
  <button onclick="removeRow('table1')" class="secondary-btn">行削除</button>
  <button onclick="addCol('table1')">列追加</button>
  <button onclick="removeCol('table1')" class="secondary-btn">列削除</button>
</div>

<h3 contenteditable="true">情報収集中の企業</h3>
<table id="table2">
  <thead>
    <tr>
      <th contenteditable="true">企業名</th>
      <th contenteditable="true">興味度</th>
      <th contenteditable="true">備考</th>
      <th contenteditable="true">情報源</th>
    </tr>
  </thead>
  <tbody>
    <tr><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
  </tbody>
</table>

<div class="button-group table-controls">
  <button onclick="addRow('table2')">行追加</button>
  <button onclick="removeRow('table2')" class="secondary-btn">行削除</button>
  <button onclick="addCol('table2')">列追加</button>
  <button onclick="removeCol('table2')" class="secondary-btn">列削除</button>
</div>

<div class="button-group global-controls">
  <button onclick="saveTables()">データ保存 (ブラウザ)</button>
  <button onclick="exportCSV()" class="secondary-btn">CSVとしてエクスポート</button>
  <button onclick="document.getElementById('csvFileInput').click()" class="secondary-btn">CSVインポート</button>
  <button onclick="resetTables()">全リセット</button>
  <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="importCSV(event)">
</div>

<script>
// 🚨 Local Storage 強制リセットコード (問題解決まで一時的に使用)
// ブラウザに保存されている古いデータがCSVインポートを妨害するのを防ぎます
if (localStorage.getItem('tableData')) {
    localStorage.removeItem('tableData');
    // コンソールログはPCのデバッグ用なので、そのまま残しておいてください
    console.log("Local Storage data has been cleared."); 
}

// --- 補助関数 ---
function getTableHeadCells(tableId) {
    const table = document.getElementById(tableId);
    if (table && table.tHead && table.tHead.rows.length > 0) {
        return table.tHead.rows[0].cells;
    }
    return [];
}
function getTableBody(tableId) {
    return document.getElementById(tableId).tBodies[0];
}

// CSVデコードヘルパー関数
const decodeCSVLine = (line) => {
  // 正規表現を使ってダブルクォートで囲まれた部分を考慮しつつカンマで分割
  const cells = line.match(/(?:"[^"]*?"|[^,]+)/g) || [];
  // 各セルからダブルクォートを削除し、エスケープされたダブルクォートを元に戻す
  return cells.map(c => c.replace(/^"|"$/g,'').replace(/""/g,'"').trim());
};

// ------------------------------------
// 1. テーブル操作関数 
// ------------------------------------
function addRow(tableId){
  const table = document.getElementById(tableId);
  let tbody = table.tBodies[0];
  if (!tbody) { tbody = table.createTBody(); }

  const headCells = getTableHeadCells(tableId);
  const cols = headCells.length;
  
  if (cols === 0) { alert("先に列（ヘッダー）を追加してください。"); return; }

  const row = tbody.insertRow();
  for(let i=0; i<cols; i++){ 
    const cell=row.insertCell(); 
    cell.contentEditable="true"; 
  }
}

function removeRow(tableId){
  const tbody = getTableBody(tableId);
  if (!tbody) return; 

  if(tbody.rows.length > 1) {
    tbody.deleteRow(-1);
  } else if (tbody.rows.length === 1) {
    Array.from(tbody.rows[0].cells).forEach(cell => cell.innerText = '');
  }
}

function addCol(tableId){
  const table = document.getElementById(tableId);
  let tbody = table.tBodies[0];
  if (!tbody) { tbody = table.createTBody(); }
  
  let tHeadRow;
  if (table.tHead && table.tHead.rows.length > 0) {
      tHeadRow = table.tHead.rows[0];
  } else {
      if (!table.tHead) table.createTHead();
      tHeadRow = table.tHead.insertRow();
  }
  
  const th = document.createElement('th'); 
  th.innerText = `新規列`;
  th.contentEditable="true"; 
  tHeadRow.appendChild(th);
  
  for(let row of tbody.rows){ 
    const cell=row.insertCell(); 
    cell.contentEditable="true"; 
  }
  
  if (tbody.rows.length === 0) {
      const row = tbody.insertRow();
      const cell = row.insertCell(); 
      cell.contentEditable="true";
  }
}

function removeCol(tableId){
  const table = document.getElementById(tableId);
  const tbody = table.tBodies[0];
  const ths = getTableHeadCells(tableId);
  
  if(ths.length > 1){ 
    ths[ths.length - 1].remove(); 
    if (tbody) {
        for(let row of tbody.rows) {
          if (row.cells.length > 0) {
            row.deleteCell(-1); 
          }
        }
    }
  } else {
      alert("最後の列は削除できません。");
  }
}

// ------------------------------------
// 2. データ操作関数 
// ------------------------------------
function resetTables(){
  document.querySelector('h1').innerText = "就職活動 メモ";
  const defaultHeaders = {
    'table1': ['企業名', '業種', '選考状況', '次回予定'],
    'table2': ['企業名', '興味度', '備考', '情報源']
  };

  document.querySelector('h3:nth-of-type(1)').innerText = "動いている企業";
  document.querySelector('h3:nth-of-type(2)').innerText = "情報収集中の企業";

  ['table1','table2'].forEach(id => {
    const table = document.getElementById(id);
    
    let tbody = table.tBodies[0];
    if (!tbody) { tbody = table.createTBody(); }
    
    let tHeadRow;
    if (table.tHead && table.tHead.rows.length > 0) {
        tHeadRow = table.tHead.rows[0];
    } else {
        if (!table.tHead) table.createTHead();
        tHeadRow = table.tHead.insertRow();
    }
    
    tHeadRow.innerHTML = '';
    defaultHeaders[id].forEach(headerText => {
      const th = document.createElement('th');
      th.contentEditable = "true";
      th.innerText = headerText;
      tHeadRow.appendChild(th);
    });

    tbody.innerHTML = '';
    const row = tbody.insertRow();
    defaultHeaders[id].forEach(() => {
        const cell = row.insertCell(); 
        cell.contentEditable = "true"; 
    });
  });
  localStorage.removeItem('tableData'); 
  alert("テーブルとローカル保存データをリセットしました！");
}

function saveTables(){
  const data={};
  data['texts']=[document.querySelector('h1').innerText, ...Array.from(document.querySelectorAll('h3')).map(h=>h.innerText)];
  
  ['table1','table2'].forEach((id,index)=>{
    const table=document.getElementById(id);
    const rows=[];
    
    const headerCells = Array.from(getTableHeadCells(id)).map(cell => cell.innerText);
    rows.push(headerCells);

    const tbody = table.tBodies[0];
    if (tbody) {
        for(let row of tbody.rows){
          const cells=[];
          for(let cell of row.cells) cells.push(cell.innerText);
          rows.push(cells);
        }
    }
    data['table'+(index+1)]=rows;
  });
  localStorage.setItem('tableData',JSON.stringify(data));
  alert("データをブラウザに保存しました！");
}

window.onload=()=>{
  const saved=localStorage.getItem('tableData');
  if(saved){
    const data=JSON.parse(saved);
    const texts=[document.querySelector('h1'), ...document.querySelectorAll('h3')];
    data.texts.forEach((txt,i)=>{ if(texts[i]) texts[i].innerText=txt; });
    
    ['table1','table2'].forEach((id,index)=>{
      const table=document.getElementById(id);
      
      if (!table.tHead || table.tHead.rows.length === 0) {
        if (!table.tHead) table.createTHead();
        table.tHead.insertRow();
      }
      const tHeadRow=table.tHead.rows[0];
      
      let tbody = table.tBodies[0];
      if (!tbody) { tbody = table.createTBody(); }
      
      const allRows=data['table'+(index+1)]; 

      const headerData = allRows[0] || [];
      tHeadRow.innerHTML = '';
      headerData.forEach(val => {
        const th = document.createElement('th');
        th.contentEditable = "true";
        th.innerText = val;
        tHeadRow.appendChild(th);
      });

      const dataRows = allRows.slice(1);
      tbody.innerHTML = '';
      
      dataRows.forEach(rowData => {
          const row = tbody.insertRow();
          rowData.forEach(cellVal => { 
              const cell = row.insertCell(); 
              cell.contentEditable="true"; 
              cell.innerText = cellVal; 
          });
      });

      if (tbody.rows.length === 0 && headerData.length > 0) {
        const row = tbody.insertRow();
        headerData.forEach(() => { 
            const cell = row.insertCell(); 
            cell.contentEditable="true"; 
        });
      }
    });
  }
}

// ------------------------------------
// 3. CSV操作関数 (exportCSV動作確認済み)
// ------------------------------------
function exportCSV(){
  let csv='"'+document.querySelector('h1').innerText.replace(/"/g,'""')+'"\n\n';
  const h3s=document.querySelectorAll('h3');
  h3s.forEach((h,index)=>{
    csv+='"'+h.innerText.replace(/"/g,'""')+'"\n';
    const table=document.getElementById('table'+(index+1));
    
    const headerCells = Array.from(getTableHeadCells('table'+(index+1))).map(cell => cell.innerText.replace(/"/g,'""'));
    csv+='"' + headerCells.join('","') + '"\n';

    const tbody = table.tBodies[0];
    if (tbody) {
        for(let row of tbody.rows){
          let cells=[];
          for(let cell of row.cells) cells.push(cell.innerText.replace(/"/g,'""'));
          csv+='"' + cells.join('","') + '"\n';
        }
    }
    csv+='\n';
  });
  const blob=new Blob(['\ufeff', csv],{type:'text/csv;charset=utf-8'}); 
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='job_search_memo.csv'; a.click();
}

// ------------------------------------
// 4. CSVインポート関数 (最終修正版)
// ------------------------------------
function importCSV(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  
  reader.onload=e=>{
    const lines=e.target.result.replace(/\ufeff/g, "").split('\n').map(l=>l.trim()).filter(l=>l!=='');
    if(lines.length<1) return;
    
    // 1. メインタイトルの復元
    if (lines[0]) {
        document.querySelector('h1').innerText = decodeCSVLine(lines[0])[0] || "就職活動 メモ";
    }
    
    let tableIndex=-1, lineIndex=2; // メインタイトル (0) と空行 (1) をスキップして、サブタイトル1 (2) から開始

    const h3s=document.querySelectorAll('h3');
    const tables=[document.getElementById('table1'), document.getElementById('table2')];
    
    while(lineIndex < lines.length){
      tableIndex++;
      if(!tables[tableIndex]) break;
      
      const table = tables[tableIndex];

      // 2. サブタイトルの復元 (例: lines[2], lines[8])
      if(h3s[tableIndex] && lines[lineIndex]) {
          h3s[tableIndex].innerText = decodeCSVLine(lines[lineIndex])[0] || "テーブルタイトル";
      }
      lineIndex++; // 次の行（ヘッダー行）へ

      // tHead/tBodyの存在チェックと作成
      if (!table.tHead) table.createTHead();
      if (table.tHead.rows.length === 0) table.tHead.insertRow();
      const tHeadRow = table.tHead.rows[0];
      
      let tbody = table.tBodies[0];
      if (!tbody) { tbody = table.createTBody(); }
      
      // ヘッダーを読み込む前に、tbodyとtHeadをクリアする
      tbody.innerHTML = '';
      tHeadRow.innerHTML = '';
      
      // 3. ヘッダー行の復元 (例: lines[3], lines[9])
      if(lineIndex < lines.length && lines[lineIndex]) {
          const headerCells = decodeCSVLine(lines[lineIndex]);
          headerCells.forEach(h => { 
              const th = document.createElement('th');
              th.contentEditable = "true";
              th.innerText = h;
              tHeadRow.appendChild(th);
          });
          lineIndex++; // 次の行（データ行）へ
      }
      
      // 4. データ行の復元
      const expectedCols = tHeadRow.cells.length;

      while(lineIndex < lines.length && lines[lineIndex]){
        const rowCells = decodeCSVLine(lines[lineIndex]);
        
        // 空行またはデータがない行を検出
        if (rowCells.length === 0 || (rowCells.length === 1 && rowCells[0] === "")) break; 
        
        // 列数が合わない行はスキップ（データではないと判断）
        if (rowCells.length !== expectedCols) {
            console.warn(`Skipping row due to column mismatch (Expected: ${expectedCols}, Found: ${rowCells.length}): ${lines[lineIndex]}`);
            lineIndex++;
            continue; 
        }

        const row = tbody.insertRow();
        rowCells.forEach(c=>{ 
            const cell=row.insertCell(); 
            cell.contentEditable="true"; 
            cell.innerText=c; 
        });
        lineIndex++;
      }
      lineIndex++; // 次のテーブルのサブタイトルへ行くために、間の空行をスキップ
    }
    alert("CSVファイルをインポートしました！");
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
