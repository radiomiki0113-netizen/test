<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>エクセル風テーブル</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 1000px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
      min-width: 80px;
    }
    th {
      background: #f0f0f0;
    }
    td[contenteditable="true"] {
      background: #fffaf0;
    }
    .buttons {
      margin-top: 15px;
    }
    button, label {
      margin-right: 10px;
      padding: 6px 12px;
      cursor: pointer;
    }
    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <h2>エクセルみたいな表（ブラウザ保存＋CSV入出力＋列追加）</h2>
  <table id="excelTable">
    <thead>
      <tr>
        <th>A</th>
        <th>B</th>
        <th>C</th>
        <th>D</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
      </tr>
      <tr>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
      </tr>
    </tbody>
  </table>

  <div class="buttons">
    <button onclick="addRow()">行を追加</button>
    <button onclick="addColumn()">列を追加</button>
    <button onclick="saveTable()">保存</button>
    <button onclick="exportCSV()">CSVとして保存</button>
    <label for="csvFile">CSVを読み込む</label>
    <input type="file" id="csvFile" accept=".csv" onchange="importCSV(event)">
    <button onclick="clearTable()">リセット</button>
  </div>

  <script>
    const table = document.getElementById("excelTable");

    // 行を追加
    function addRow() {
      const row = table.insertRow(-1);
      const colCount = table.rows[0].cells.length;
      for (let i = 0; i < colCount; i++) {
        const cell = row.insertCell(i);
        cell.contentEditable = "true";
      }
    }

    // 列を追加
    function addColumn() {
      const headerRow = table.rows[0];
      const newIndex = headerRow.cells.length;
      const colName = String.fromCharCode(65 + (newIndex % 26)) + (newIndex >= 26 ? Math.floor(newIndex / 26) : "");
      const th = document.createElement("th");
      th.innerText = colName;
      headerRow.appendChild(th);

      // 各行にセルを追加
      for (let i = 1; i < table.rows.length; i++) {
        const cell = table.rows[i].insertCell(-1);
        cell.contentEditable = "true";
      }
    }

    // 保存（localStorage）
    function saveTable() {
      let data = [];
      for (let i = 1; i < table.rows.length; i++) {
        let row = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) {
          row.push(table.rows[i].cells[j].innerText);
        }
        data.push(row);
      }
      localStorage.setItem("excelData", JSON.stringify(data));
      localStorage.setItem("excelCols", table.rows[0].cells.length);
      alert("保存しました（ブラウザに保存）");
    }

    // 読み込み
    function loadTable() {
      const saved = localStorage.getItem("excelData");
      const savedCols = localStorage.getItem("excelCols");
      if (saved) {
        const data = JSON.parse(saved);

        // 列数を調整
        if (savedCols) {
          const cols = parseInt(savedCols);
          while (table.rows[0].cells.length < cols) {
            addColumn();
          }
        }

        // 行を初期化
        for (let i = table.rows.length - 1; i > 0; i--) {
          table.deleteRow(i);
        }

        // データを反映
        data.forEach(rowData => {
          const row = table.insertRow(-1);
          rowData.forEach(cellData => {
            const cell = row.insertCell(-1);
            cell.contentEditable = "true";
            cell.innerText = cellData;
          });
        });
      }
    }

    // CSV出力
    function exportCSV() {
      let csv = [];
      for (let i = 0; i < table.rows.length; i++) {
        let row = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) {
          let text = table.rows[i].cells[j].innerText.replace(/"/g, '""');
          row.push('"' + text + '"');
        }
        csv.push(row.join(","));
      }
      const csvContent = csv.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "table.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // CSVインポート
    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split(/\r?\n/).map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));

        // ヘッダー行を調整
        const maxCols = Math.max(...rows.map(r => r.length));
        while (table.rows[0].cells.length < maxCols) {
          addColumn();
        }

        // 表を初期化（ヘッダー以外削除）
        for (let i = table.rows.length - 1; i > 0; i--) {
          table.deleteRow(i);
        }

        // 行を追加して値を反映
        rows.forEach(rowData => {
          if (rowData.length === 1 && rowData[0] === "") return;
          const row = table.insertRow(-1);
          rowData.forEach(cellData => {
            const cell = row.insertCell(-1);
            cell.contentEditable = "true";
            cell.innerText = cellData.replace(/^"|"$/g, "").replace(/""/g, '"');
          });
        });
      };
      reader.readAsText(file);
    }

    // リセット
    function clearTable() {
      if (confirm("表をリセットしてもいいですか？（保存データも消えます）")) {
        localStorage.removeItem("excelData");
        localStorage.removeItem("excelCols");
        for (let i = table.rows.length - 1; i > 0; i--) {
          table.deleteRow(i);
        }
        while (table.rows[0].cells.length > 4) {
          table.rows[0].deleteCell(-1);
        }
        addRow();
        addRow();
      }
    }

    // ページ読み込み時に自動でデータ復元
    window.onload = loadTable;
  </script>
</body>
</html>