<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å°±è·æ´»å‹• ãƒ¡ãƒ¢</title>
<style>
/* ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³CSS (Flexboxã§tdã®æç”»ã‚’æ ¹æœ¬çš„ã«å¤‰æ›´) */
:root {
  --primary-color: #007bff;
  --secondary-color: #6c757d;
  --light-bg: #f8f9fa;
  --border-color: #dee2e6;
  --header-bg: #e9ecef;
}
body { 
  font-family: 'Helvetica Neue', Arial, sans-serif; 
  padding: 30px; 
  background-color: var(--light-bg);
  color: #333;
  max-width: 1200px;
  margin: 0 auto;
}

/* ğŸš© H1ã¨H3ã«ã‚‚ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ç·¨é›†æ©Ÿèƒ½ã‚’ä»˜ä¸ (contenteditableã‚’å»ƒæ­¢) */
h1 { 
  font-size: 28px; 
  border-bottom: 3px solid var(--primary-color);
  padding-bottom: 10px;
  margin-bottom: 30px;
  color: #212529;
  cursor: pointer; /* ç·¨é›†å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºå”† */
}
h3 { 
  font-size: 20px; 
  margin-top: 30px; 
  margin-bottom: 15px; 
  font-weight: 600;
  color: var(--primary-color);
  cursor: pointer; /* ç·¨é›†å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºå”† */
}

table { 
  border-collapse: collapse; 
  margin-bottom: 25px; 
  width: 100%; 
  table-layout: fixed; 
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
  background-color: white;
}
th { 
  border: 1px solid var(--border-color); 
  padding: 12px 15px; 
  white-space: normal;
  word-wrap: break-word;
  vertical-align: top;
  background-color: var(--header-bg); 
  font-weight: bold;
  color: #495057;
  position: sticky; 
  top: 0;
  z-index: 10;
  text-align: left;
}

/* ğŸš© æ±ºå®šçš„ãªä¿®æ­£: tdã®æç”»ã‚’Flexboxã«ç½®ãæ›ãˆã‚‹ */
td {
  border: 1px solid var(--border-color); 
  /* paddingã‚’ãªãã—ã€Flexboxã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’åˆ¶å¾¡ */
  padding: 0; 
  white-space: normal;
  word-wrap: break-word;
  position: relative; /* inputã®ä½ç½®åŸºæº– */
  height: 60px; /* æœ€å°é«˜ã•ã‚’ç¢ºä¿ */
  
  /* Flexboxã§ã‚»ãƒ«å†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å¼·åˆ¶çš„ã«ä¸­å¤®æƒãˆ */
  display: flex;
  justify-content: center; /* æ°´å¹³ä¸­å¤®æƒãˆ */
  align-items: center; /* å‚ç›´ä¸­å¤®æƒãˆ */
}

/* ğŸš© ã‚»ãƒ«å†…ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆdivï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.cell-content-wrapper {
  /* Flexã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ãƒ•ã‚£ãƒƒãƒˆã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®æƒãˆ */
  text-align: center !important; 
  box-sizing: border-box;
  /* è¦–è¦šçš„ãªpaddingã‚’flexboxã®å­è¦ç´ ã§å®Ÿç¾ */
  padding: 12px 15px;
  width: 100%; /* æ¨ªå¹…ã„ã£ã±ã„ã«ã™ã‚‹ */
  height: 100%;
  display: block; /* ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ã®ãŸã‚blockã«æˆ»ã™ */
}

/* ğŸš© ç·¨é›†ç”¨Inputè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.cell-input {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  box-sizing: border-box;
  border: none;
  background-color: #fffacd; 
  padding: 12px 15px;
  font-family: inherit;
  font-size: inherit;
  text-align: center !important; 
  outline: 1px solid var(--primary-color);
  z-index: 20; 
}

/* ğŸš© H1/H3ç·¨é›†ç”¨ã®Inputã‚¹ã‚¿ã‚¤ãƒ« */
.text-input {
    width: 100%;
    box-sizing: border-box;
    font-family: inherit;
    font-size: inherit;
    border: 1px solid var(--primary-color);
    padding: 5px;
    margin: 0;
}

.button-group {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.table-controls {
    border: 1px solid var(--border-color);
    padding: 10px;
    border-radius: 5px;
    background-color: white;
}
.global-controls {
    margin-top: 20px;
    padding: 10px 0;
}
button {
  background-color: var(--primary-color);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s;
  font-weight: 500;
}
button:hover {
  background-color: #0056b3;
}
button:active {
  transform: scale(0.98);
}
.secondary-btn {
  background-color: var(--secondary-color);
}
.secondary-btn:hover {
  background-color: #5a6268;
}
</style>
</head>
<body>

<h1 ondblclick="makeEditableH3(this)">å°±è·æ´»å‹• ãƒ¡ãƒ¢</h1>
<br>

<h3 ondblclick="makeEditableH3(this)">å‹•ã„ã¦ã„ã‚‹ä¼æ¥­</h3>
<table id="table1">
  <thead>
    <tr>
      <th contenteditable="true">ä¼æ¥­å</th>
      <th contenteditable="true">æ¥­ç¨®</th>
      <th contenteditable="true">é¸è€ƒçŠ¶æ³</th>
      <th contenteditable="true">æ¬¡å›äºˆå®š</th>
    </tr>
  </thead>
  <tbody>
    <tr>
        <td ondblclick="makeEditable(this)"></td>
        <td ondblclick="makeEditable(this)"></td>
        <td ondblclick="makeEditable(this)"></td>
        <td ondblclick="makeEditable(this)"></td>
    </tr>
  </tbody>
</table>

<div class="button-group table-controls">
  <button onclick="addRow('table1')">è¡Œè¿½åŠ </button>
  <button onclick="removeRow('table1')" class="secondary-btn">è¡Œå‰Šé™¤</button>
  <button onclick="addCol('table1')">åˆ—è¿½åŠ </button>
  <button onclick="removeCol('table1')" class="secondary-btn">åˆ—å‰Šé™¤</button>
</div>

<h3 ondblclick="makeEditableH3(this)">æƒ…å ±åé›†ä¸­ã®ä¼æ¥­</h3>
<table id="table2">
  <thead>
    <tr>
      <th contenteditable="true">ä¼æ¥­å</th>
      <th contenteditable="true">èˆˆå‘³åº¦</th>
      <th contenteditable="true">å‚™è€ƒ</th>
      <th contenteditable="true">æƒ…å ±æº</th>
    </tr>
  </thead>
  <tbody>
    <tr>
        <td ondblclick="makeEditable(this)"></td>
        <td ondblclick="makeEditable(this)"></td>
        <td ondblclick="makeEditable(this)"></td>
        <td ondblclick="makeEditable(this)"></td>
    </tr>
  </tbody>
</table>

<div class="button-group table-controls">
  <button onclick="addRow('table2')">è¡Œè¿½åŠ </button>
  <button onclick="removeRow('table2')" class="secondary-btn">è¡Œå‰Šé™¤</button>
  <button onclick="addCol('table2')">åˆ—è¿½åŠ </button>
  <button onclick="removeCol('table2')" class="secondary-btn">åˆ—å‰Šé™¤</button>
</div>

<div class="button-group global-controls">
  <button onclick="saveTables()">ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (ãƒ–ãƒ©ã‚¦ã‚¶)</button>
  <button onclick="exportCSV()" class="secondary-btn">CSVã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button onclick="document.getElementById('csvFileInput').click()" class="secondary-btn">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  <button onclick="resetTables()">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
  <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="importCSV(event)">
</div>

<script>
// Local Storage å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆã‚³ãƒ¼ãƒ‰ (å•é¡Œè§£æ±ºã¾ã§ä¸€æ™‚çš„ã«ä½¿ç”¨)
if (localStorage.getItem('tableData')) {
    localStorage.removeItem('tableData');
    console.log("Local Storage data has been cleared."); 
}

// ------------------------------------
// ğŸš© æ ¸å¿ƒã¨ãªã‚‹ã‚»ãƒ«æ“ä½œé–¢æ•° (Flexboxå¯¾å¿œ)
// ------------------------------------

// H1/H3ã‚’ç·¨é›†å¯èƒ½ã«ã™ã‚‹é–¢æ•°
function makeEditableH3(element) {
    if (element.querySelector('input')) return;

    const originalText = element.innerText;
    const originalDisplay = element.style.display;
    
    // ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤ºã«ã™ã‚‹
    element.innerText = '';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'text-input';
    input.value = originalText;
    
    input.onblur = function() {
        element.innerText = this.value;
        this.remove();
        element.style.display = originalDisplay; // å…ƒã®è¡¨ç¤ºå½¢å¼ã«æˆ»ã™
    };

    input.onkeydown = function(e) {
        if (e.key === 'Enter') {
            this.blur();
        }
    };

    element.appendChild(input);
    input.focus();
}

// ã‚»ãƒ«å†…ã«<div>ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½œæˆã™ã‚‹é–¢æ•°
function wrapContent(cell, text = '') {
    // æ—¢å­˜ã®ãƒ©ãƒƒãƒ‘ãƒ¼ãŒã‚ã‚Œã°ãã‚Œã‚’å†åˆ©ç”¨
    let wrapper = cell.querySelector('.cell-content-wrapper');
    if (!wrapper) { 
        wrapper = document.createElement('div');
        wrapper.className = 'cell-content-wrapper';
        cell.appendChild(wrapper);
    }
    wrapper.innerText = text;
}

// ã‚»ãƒ«å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getCellText(cell) {
    const wrapper = cell.querySelector('.cell-content-wrapper');
    return wrapper ? wrapper.innerText : '';
}

// ã‚»ãƒ«å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹é–¢æ•°
function setCellText(cell, text) {
    const wrapper = cell.querySelector('.cell-content-wrapper');
    if (wrapper) {
        wrapper.innerText = text;
    } else {
        wrapContent(cell, text);
    }
}

// ã‚»ãƒ«ã‚’ç·¨é›†å¯èƒ½ã«ã™ã‚‹é–¢æ•° (ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚)
function makeEditable(cell) {
    if (cell.querySelector('input')) return; 

    // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
    const originalText = getCellText(cell);
    
    // inputè¦ç´ ã‚’ä½œæˆ
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-input';
    input.value = originalText;
    
    input.onblur = function() {
        const newText = this.value;
        const parentCell = this.parentElement;
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‚’tdå†…ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã«æˆ»ã—ã€inputè¦ç´ ã‚’å‰Šé™¤
        setCellText(parentCell, newText);
        this.remove(); 
    };

    input.onkeydown = function(e) {
        if (e.key === 'Enter') {
            this.blur();
        }
    };
    
    // ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã€inputã‚’æŒ¿å…¥
    const wrapper = cell.querySelector('.cell-content-wrapper');
    if(wrapper) wrapper.style.display = 'none';

    cell.appendChild(input);
    input.focus(); 
}

// --- è£œåŠ©é–¢æ•° ---
function getTableHeadCells(tableId) {
    const table = document.getElementById(tableId);
    if (table && table.tHead && table.tHead.rows.length > 0) {
        return table.tHead.rows[0].cells;
    }
    return [];
}
function getTableBody(tableId) {
    return document.getElementById(tableId).tBodies[0];
}

// CSVãƒ‡ã‚³ãƒ¼ãƒ‰ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
const decodeCSVLine = (line) => {
  const cells = line.match(/(?:"[^"]*?"|[^,]+)/g) || [];
  return cells.map(c => c.replace(/^"|"$/g,'').replace(/""/g,'"').trim());
};

// ------------------------------------
// 1. ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œé–¢æ•° (Flexboxå¯¾å¿œ)
// ------------------------------------
function addRow(tableId){
  const table = document.getElementById(tableId);
  let tbody = table.tBodies[0];
  if (!tbody) { tbody = table.createTBody(); }

  const headCells = getTableHeadCells(tableId);
  const cols = headCells.length;
  
  if (cols === 0) { alert("å…ˆã«åˆ—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚"); return; }

  const row = tbody.insertRow();
  for(let i=0; i<cols; i++){ 
    const cell=row.insertCell(); 
    cell.ondblclick = function() { makeEditable(this); }; 
    wrapContent(cell); 
  }
}

function removeRow(tableId){
  const tbody = getTableBody(tableId);
  if (!tbody) return; 

  if(tbody.rows.length > 1) {
    tbody.deleteRow(-1);
  } else if (tbody.rows.length === 1) {
    Array.from(tbody.rows[0].cells).forEach(cell => setCellText(cell, ''));
  }
}

function addCol(tableId){
  const table = document.getElementById(tableId);
  let tbody = table.tBodies[0];
  if (!tbody) { tbody = table.createTBody(); }
  
  let tHeadRow;
  if (table.tHead && table.tHead.rows.length > 0) {
      tHeadRow = table.tHead.rows[0];
  } else {
      if (!table.tHead) table.createTHead();
      tHeadRow = table.tHead.insertRow();
  }
  
  const th = document.createElement('th'); 
  th.innerText = `æ–°è¦åˆ—`;
  th.contentEditable="true"; 
  tHeadRow.appendChild(th);
  
  for(let row of tbody.rows){ 
    const cell=row.insertCell(); 
    cell.ondblclick = function() { makeEditable(this); }; 
    wrapContent(cell);
  }
  
  if (tbody.rows.length === 0) {
      const row = tbody.insertRow();
      const cell = row.insertCell(); 
      cell.ondblclick = function() { makeEditable(this); }; 
      wrapContent(cell);
  }
}

function removeCol(tableId){
  const table = document.getElementById(tableId);
  const tbody = table.tBodies[0];
  const ths = getTableHeadCells(tableId);
  
  if(ths.length > 1){ 
    ths[ths.length - 1].remove(); 
    if (tbody) {
        for(let row of tbody.rows) {
          if (row.cells.length > 0) {
            row.deleteCell(-1); 
          }
        }
    }
  } else {
      alert("æœ€å¾Œã®åˆ—ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
  }
}

// ------------------------------------
// 2. ãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢æ•° 
// ------------------------------------
function resetTables(){
    // è¦‹å‡ºã—ã‚’åˆæœŸåŒ–
    document.querySelector('h1').innerText = "å°±è·æ´»å‹• ãƒ¡ãƒ¢";
    document.querySelector('h3:nth-of-type(1)').innerText = "å‹•ã„ã¦ã„ã‚‹ä¼æ¥­";
    document.querySelector('h3:nth-of-type(2)').innerText = "æƒ…å ±åé›†ä¸­ã®ä¼æ¥­";

    const defaultHeaders = {
        'table1': ['ä¼æ¥­å', 'æ¥­ç¨®', 'é¸è€ƒçŠ¶æ³', 'æ¬¡å›äºˆå®š'],
        'table2': ['ä¼æ¥­å', 'èˆˆå‘³åº¦', 'å‚™è€ƒ', 'æƒ…å ±æº']
    };

    ['table1','table2'].forEach(id => {
        const table = document.getElementById(id);
        
        // 1. THï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ãƒ«ï¼‰ã‚’åˆæœŸåŒ–
        let tHeadRow;
        if (table.tHead && table.tHead.rows.length > 0) {
            tHeadRow = table.tHead.rows[0];
        } else {
            if (!table.tHead) table.createTHead();
            tHeadRow = table.tHead.insertRow();
        }
        tHeadRow.innerHTML = '';
        defaultHeaders[id].forEach(headerText => {
            const th = document.createElement('th');
            th.contentEditable = "true";
            th.innerText = headerText;
            tHeadRow.appendChild(th);
        });
        
        // 2. TBodyï¼ˆãƒ‡ãƒ¼ã‚¿è¡Œï¼‰ã‚’åˆæœŸåŒ–
        let tbody = table.tBodies[0];
        if (!tbody) { tbody = table.createTBody(); }
        tbody.innerHTML = '';
        const row = tbody.insertRow();
        const headerCount = defaultHeaders[id].length;
        for (let i = 0; i < headerCount; i++) {
            const cell = row.insertCell(); 
            cell.ondblclick = function() { makeEditable(this); }; 
            wrapContent(cell); 
        }
    });
    localStorage.removeItem('tableData'); // Local Storageã‚‚ã‚¯ãƒªã‚¢
}

function saveTables(){
  const data={};
  // H1/H3ã¯innerTextã§ä¿å­˜
  data['texts']=[document.querySelector('h1').innerText, ...Array.from(document.querySelectorAll('h3')).map(h=>h.innerText)];
  
  ['table1','table2'].forEach((id,index)=>{
    const table=document.getElementById(id);
    const rows=[];
    
    const headerCells = Array.from(getTableHeadCells(id)).map(cell => cell.innerText);
    rows.push(headerCells);

    const tbody = table.tBodies[0];
    if (tbody) {
        for(let row of tbody.rows){
          const cells=[];
          // getCellTextã‚’ä½¿ã£ã¦ãƒ©ãƒƒãƒ‘ãƒ¼å†…ã®ç´”ç²‹ãªãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
          for(let cell of row.cells) cells.push(getCellText(cell)); 
          rows.push(cells);
        }
    }
    data['table'+(index+1)]=rows;
  });
  localStorage.setItem('tableData',JSON.stringify(data));
  alert("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸï¼");
}

window.onload=()=>{
  const saved=localStorage.getItem('tableData');
  
  // H1ã¨H3ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä»˜ä¸
  document.querySelector('h1').ondblclick = function() { makeEditableH3(this); };
  document.querySelectorAll('h3').forEach(h => {
    h.ondblclick = function() { makeEditableH3(this); };
  });

  if(saved){
    const data=JSON.parse(saved);
    const texts=[document.querySelector('h1'), ...document.querySelectorAll('h3')];
    data.texts.forEach((txt,i)=>{ 
        if(texts[i]) texts[i].innerText=txt; 
    });
    
    ['table1','table2'].forEach((id,index)=>{
      const table=document.getElementById(id);
      
      if (!table.tHead || table.tHead.rows.length === 0) {
        if (!table.tHead) table.createTHead();
        table.tHead.insertRow();
      }
      const tHeadRow=table.tHead.rows[0];
      
      let tbody = table.tBodies[0];
      if (!tbody) { tbody = table.createTBody(); }
      
      const allRows=data['table'+(index+1)]; 

      const headerData = allRows[0] || [];
      tHeadRow.innerHTML = '';
      headerData.forEach(val => {
        const th = document.createElement('th');
        th.contentEditable = "true";
        th.innerText = val;
        tHeadRow.appendChild(th);
      });

      const dataRows = allRows.slice(1);
      tbody.innerHTML = '';
      
      dataRows.forEach(rowData => {
          const row = tbody.insertRow();
          rowData.forEach(cellVal => { 
              const cell = row.insertCell(); 
              cell.ondblclick = function() { makeEditable(this); }; 
              setCellText(cell, cellVal); // ãƒ©ãƒƒãƒ‘ãƒ¼å†…ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
          });
      });

      if (tbody.rows.length === 0 && headerData.length > 0) {
        const row = tbody.insertRow();
        headerData.forEach(() => { 
            const cell = row.insertCell(); 
            cell.ondblclick = function() { makeEditable(this); }; 
            wrapContent(cell); // ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’æŒ¿å…¥
        });
      }
    });
  } else {
    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€åˆæœŸã®<td>ã«ã‚‚ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’æŒ¿å…¥
    document.querySelectorAll('#table1 tbody td, #table2 tbody td').forEach(cell => {
      wrapContent(cell);
    });
  }
}

// ------------------------------------
// 3. CSVæ“ä½œé–¢æ•° 
// ------------------------------------
function exportCSV(){
  let csv='"'+document.querySelector('h1').innerText.replace(/"/g,'""')+'"\n\n';
  const h3s=document.querySelectorAll('h3');
  
  h3s.forEach((h,index)=>{
    csv+='"'+h.innerText.replace(/"/g,'""')+'"\n';
    const table=document.getElementById('table'+(index+1));
    
    if (index === 1) {
        csv += '\n'; 
    }

    const headerCells = Array.from(getTableHeadCells('table'+(index+1))).map(cell => cell.innerText.replace(/"/g,'""'));
    csv+='"' + headerCells.join('","') + '"\n';

    const tbody = table.tBodies[0];
    if (tbody) {
        for(let row of tbody.rows){
          let cells=[];
          // getCellTextã‚’ä½¿ã£ã¦ãƒ©ãƒƒãƒ‘ãƒ¼å†…ã®ç´”ç²‹ãªãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
          for(let cell of row.cells) cells.push(getCellText(cell).replace(/"/g,'""'));
          csv+='"' + cells.join('","') + '"\n';
        }
    }
    csv+='\n';
  });
  const blob=new Blob(['\ufeff', csv],{type:'text/csv;charset=utf-8'}); 
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='job_search_memo.csv'; a.click();
}

// ------------------------------------
// 4. CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢æ•° 
// ------------------------------------
function importCSV(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  
  reader.onload=e=>{
    const lines=e.target.result.replace(/\ufeff/g, "").split('\n').map(l=>l.trim()).filter(l=>l!=='');
    if(lines.length<1) return;
    
    let tableIndex=-1, lineIndex=1; 
    const h3s=document.querySelectorAll('h3');
    const tables=[document.getElementById('table1'), document.getElementById('table2')];
    
    // H1ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‡¦ç†
    if (lines[0]) {
        document.querySelector('h1').innerText = decodeCSVLine(lines[0])[0] || "å°±è·æ´»å‹• ãƒ¡ãƒ¢";
        lineIndex++;
    }

    // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
    while (lineIndex < lines.length && lines[lineIndex].trim() === '') {
        lineIndex++;
    }

    while(lineIndex < lines.length && tableIndex < 2){
      tableIndex++;
      const table = tables[tableIndex];

      // H3ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‡¦ç†
      if(h3s[tableIndex] && lines[lineIndex]) {
          const decodedLine = decodeCSVLine(lines[lineIndex]);
          
          if (decodedLine.length === 1 && decodedLine[0] !== "") {
              h3s[tableIndex].innerText = decodedLine[0];
              lineIndex++; 
          }
      }
      
      // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
      while (lineIndex < lines.length && lines[lineIndex].trim() === '') {
          lineIndex++;
      }
      
      if (!table.tHead) table.createTHead();
      if (table.tHead.rows.length === 0) table.tHead.insertRow();
      const tHeadRow = table.tHead.rows[0];
      
      let tbody = table.tBodies[0];
      if (!tbody) { tbody = table.createTBody(); }
      
      tbody.innerHTML = '';
      tHeadRow.innerHTML = '';
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‡¦ç†
      if(lineIndex < lines.length && lines[lineIndex]) {
          const headerCells = decodeCSVLine(lines[lineIndex]);
          headerCells.forEach(h => { 
              const th = document.createElement('th');
              th.contentEditable = "true";
              th.innerText = h;
              tHeadRow.appendChild(th);
          });
          lineIndex++; 
      }
      
      const expectedCols = tHeadRow.cells.length;

      // ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
      while(lineIndex < lines.length && lines[lineIndex]){
        const rowCells = decodeCSVLine(lines[lineIndex]);
        
        // æ¬¡ã®H3ã‚¿ã‚¤ãƒˆãƒ«ã‚„ç©ºè¡Œã«ã¶ã¤ã‹ã£ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
        if (rowCells.length === 1 && rowCells[0] !== "") {
            break;
        }
        if (lines[lineIndex].trim() === '') {
            break;
        }

        const row = tbody.insertRow();
        for (let i = 0; i < expectedCols; i++) {
            const cell = row.insertCell(); 
            const cellVal = rowCells[i] ? rowCells[i] : ''; 
            
            cell.ondblclick = function() { makeEditable(this); }; 
            setCellText(cell, cellVal); // ãƒ©ãƒƒãƒ‘ãƒ¼å†…ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
        }
        lineIndex++;
      }
      
      lineIndex++; 
    }
    alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼");
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
