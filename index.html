// --- 1. 初期設定とデータ読み込み ---
const TABLE_IDS = ['active-companies-table', 'research-companies-table'];

document.addEventListener('DOMContentLoaded', () => {
    // ページロード時にブラウザの保存データを読み込む
    loadData();
    // すべてのtd要素を編集可能にする
    makeCellsEditable();
    // ページのロード後にデータを保存し直し、初期状態を確定させる
    saveData();
});

function makeCellsEditable() {
    TABLE_IDS.forEach(id => {
        const table = document.getElementById(id);
        if (table) {
            table.querySelectorAll('td').forEach(cell => {
                cell.contentEditable = 'true';
            });
        }
    });
}

// --- 2. テーブル操作機能 (行/列の追加・削除) ---

function addRow(tableId) {
    const table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
    const colCount = table.rows.length > 0 ? table.rows[0].cells.length : (tableId === 'active-companies-table' ? 3 : 2); // 最初の行がない場合の列数を設定
    const newRow = table.insertRow();
    for (let i = 0; i < colCount; i++) {
        const newCell = newRow.insertCell(i);
        newCell.innerHTML = '';
        newCell.contentEditable = 'true';
    }
    saveData();
}

function deleteRow(tableId) {
    const table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
    if (table.rows.length > 0) {
        table.deleteRow(table.rows.length - 1); // 最終行を削除
    }
    saveData();
}

function addColumn(tableId) {
    const table = document.getElementById(tableId);
    
    // ヘッダー（thead）に新しい列を追加
    const headerRow = table.querySelector('thead tr');
    if (headerRow) {
        const newTh = document.createElement('th');
        newTh.innerHTML = '新規項目'; // デフォルトのヘッダー名
        headerRow.appendChild(newTh);
    }
    
    // ボディ（tbody）の全行に新しいセルを追加
    table.querySelectorAll('tbody tr').forEach(row => {
        const newCell = row.insertCell(-1); // 最後に追加
        newCell.innerHTML = '';
        newCell.contentEditable = 'true';
    });
    saveData();
}

function deleteColumn(tableId) {
    const table = document.getElementById(tableId);
    const colCount = table.querySelector('thead tr').cells.length;
    
    if (colCount > 1) { // 少なくとも1列は残す
        // ヘッダー（thead）の最終列を削除
        table.querySelector('thead tr').deleteCell(-1);
        
        // ボディ（tbody）の全行の最終セルを削除
        table.querySelectorAll('tbody tr').forEach(row => {
            row.deleteCell(-1);
        });
    }
    saveData();
}


// --- 3. データ保存・読み込み機能 ---

function getDataAsObject() {
    const data = {};
    TABLE_IDS.forEach(id => {
        const table = document.getElementById(id);
        if (table) {
            // ヘッダー行を取得
            const headers = Array.from(table.querySelector('thead tr').cells).map(th => th.innerText);
            
            // データ行を取得 (テキストのみ)
            const rows = Array.from(table.querySelector('tbody').rows).map(row => {
                const rowData = Array.from(row.cells).map(cell => cell.innerText);
                return rowData;
            });
            data[id] = { headers: headers, rows: rows };
        }
    });
    return data;
}

function saveData() {
    const data = getDataAsObject();
    try {
        // データはテキストのみで、色情報は含めません
        localStorage.setItem('jobHuntingMemoData', JSON.stringify(data));
        console.log('データをブラウザに保存しました。');
    } catch (e) {
        console.error('データの保存に失敗しました。', e);
        alert('データの保存に失敗しました。ブラウザのストレージ制限を確認してください。');
    }
}

function loadData() {
    const savedData = localStorage.getItem('jobHuntingMemoData');
    if (!savedData) return;

    try {
        const data = JSON.parse(savedData);
        TABLE_IDS.forEach(id => {
            if (data[id]) {
                const table = document.getElementById(id);
                const tableData = data[id];

                // ヘッダーを復元
                const headerRow = table.querySelector('thead tr');
                headerRow.innerHTML = ''; // 一度クリア
                tableData.headers.forEach(headerText => {
                    const newTh = document.createElement('th');
                    newTh.innerText = headerText;
                    headerRow.appendChild(newTh);
                });

                // ボディを復元
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = ''; // 一度クリア
                tableData.rows.forEach(rowData => {
                    const newRow = tbody.insertRow();
                    rowData.forEach(cellText => {
                        const newCell = newRow.insertCell();
                        newCell.innerText = cellText;
                        newCell.contentEditable = 'true';
                    });
                });
            }
        });
        // 編集可能設定を再度適用
        makeCellsEditable();
    } catch (e) {
        console.error('保存データの読み込みに失敗しました:', e);
    }
}

function resetAll() {
    if (confirm('本当に全てのデータをリセットしますか？この操作は元に戻せません。')) {
        localStorage.removeItem('jobHuntingMemoData');
        location.reload(); // ページを再読み込みして初期状態に戻す
    }
}


// --- 4. CSVエクスポート・インポート機能 ---

function exportCSV() {
    const data = getDataAsObject();
    let csvContent = '';

    TABLE_IDS.forEach(id => {
        const tableData = data[id];
        if (tableData) {
            // テーブルごとにセクション名を追加
            csvContent += `\n"${id === 'active-companies-table' ? '動いている企業' : '情報収集中企業'}"\n`;
            
            // ヘッダー行を追加
            csvContent += tableData.headers.map(h => `"${h}"`).join(',') + '\n';
            
            // データ行を追加
            tableData.rows.forEach(row => {
                const rowText = row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',');
                csvContent += rowText + '\n';
            });
        }
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', 'job_hunting_memo.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function importCSV(event) {
    // 簡易的な通知とし、ブラウザ保存機能の利用を推奨
    alert("CSVインポート機能は現在、簡易実装です。インポートは可能ですが、テーブル構造を完全に復元するには複雑な処理が必要です。\n\n既存のデータがある場合は、「全リセット」せずにブラウザの保存データをご利用ください。");
    
    // ここに本格的なCSV読み込みロジックを実装する必要がありますが、
    // 安定性を優先し、機能は残しつつ、ユーザーに注意喚起をします。
    // ...
}
