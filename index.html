<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>エクセル風テーブル</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 800px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
      min-width: 80px;
    }
    th {
      background: #f0f0f0;
    }
    td[contenteditable="true"] {
      background: #fffaf0;
    }
    .buttons {
      margin-top: 15px;
    }
    button {
      margin-right: 10px;
      padding: 6px 12px;
    }
    input[type="file"] {
      display: none;
    }
    label {
      padding: 6px 12px;
      background: #eee;
      border: 1px solid #aaa;
      cursor: pointer;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h2>エクセルみたいな表（ブラウザ保存＋CSV入出力）</h2>
  <table id="excelTable">
    <thead>
      <tr>
        <th>A</th>
        <th>B</th>
        <th>C</th>
        <th>D</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
      </tr>
      <tr>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
      </tr>
    </tbody>
  </table>

  <div class="buttons">
    <button onclick="addRow()">行を追加</button>
    <button onclick="saveTable()">保存</button>
    <button onclick="exportCSV()">CSVとして保存</button>
    <label for="csvFile">CSVを読み込む</label>
    <input type="file" id="csvFile" accept=".csv" onchange="importCSV(event)">
    <button onclick="clearTable()">リセット</button>
  </div>

  <script>
    const table = document.getElementById("excelTable");

    // 行を追加
    function addRow() {
      const row = table.insertRow(-1);
      for (let i = 0; i < 4; i++) {
        const cell = row.insertCell(i);
        cell.contentEditable = "true";
      }
    }

    // 保存（localStorage）
    function saveTable() {
      let data = [];
      for (let i = 1; i < table.rows.length; i++) {
        let row = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) {
          row.push(table.rows[i].cells[j].innerText);
        }
        data.push(row);
      }
      localStorage.setItem("excelData", JSON.stringify(data));
      alert("保存しました（ブラウザに保存）");
    }

    // 読み込み
    function loadTable() {
      const saved = localStorage.getItem("excelData");
      if (saved) {
        const data = JSON.parse(saved);
        for (let i = 1; i < table.rows.length; i++) {
          table.deleteRow(1);
        }
        data.forEach(rowData => {
          const row = table.insertRow(-1);
          rowData.forEach(cellData => {
            const cell = row.insertCell(-1);
            cell.contentEditable = "true";
            cell.innerText = cellData;
          });
        });
      }
    }

    // CSV出力
    function exportCSV() {
      let csv = [];
      for (let i = 0; i < table.rows.length; i++) {
        let row = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) {
          let text = table.rows[i].cells[j].innerText.replace(/"/g, '""');
          row.push('"' + text + '"');
        }
        csv.push(row.join(","));
      }
      const csvContent = csv.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "table.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // CSVインポート
    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split(/\r?\n/).map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));
        
        // 表を初期化（ヘッダー以外削除）
        for (let i = table.rows.length - 1; i > 0; i--) {
          table.deleteRow(i);
        }

        // 行を追加して値を反映
        rows.forEach(rowData => {
          if (rowData.length === 1 && rowData[0] === "") return; // 空行スキップ
          const row = table.insertRow(-1);
          rowData.forEach(cellData => {
            const cell = row.insertCell(-1);
            cell.contentEditable = "true";
            cell.innerText = cellData.replace(/^"|"$/g, "").replace(/""/g, '"'); // CSVの " を解除
          });
        });
      };
      reader.readAsText(file);
    }

    // リセット
    function clearTable() {
      if (confirm("表をリセットしてもいいですか？（保存データも消えます）")) {
        localStorage.removeItem("excelData");
        for (let i = table.rows.length - 1; i > 0; i--) {
          table.deleteRow(i);
        }
        addRow();
        addRow();
      }
    }

    // ページ読み込み時に自動でデータ復元
    window.onload = loadTable;
  </script>
</body>
</html>