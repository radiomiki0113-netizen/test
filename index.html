<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°±è·æ´»å‹•ãƒ¡ãƒ¢</title>
<style>
/* ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³CSS - æœ€çµ‚å®Œå…¨ç‰ˆ */
:root {
  --primary-color: #007bff;
  --secondary-color: #6c757d;
  --light-bg: #f8f9fa;
  --border-color: #dee2e6;
  --header-bg: #f5f5f5; /* é …ç›®è¡Œã«ç›®ç«‹ãŸãªã„è–„ã„èƒŒæ™¯è‰²ã‚’é©ç”¨ */
  
  /* ğŸš© ã‚»ãƒ«ã‚«ãƒ©ãƒ¼ç”¨ã®å®šç¾© */
  --color-yellow: #fff3cd; 
  --color-green: #d4edda;
  --color-red: #f8d7da;
}
body { 
  font-family: 'Helvetica Neue', Arial, sans-serif; 
  padding: 30px; 
  background-color: var(--light-bg);
  color: #333;
  max-width: 1200px;
  margin: 0 auto;
}

h1 { 
  font-size: 28px; 
  border-bottom: 3px solid var(--primary-color);
  padding-bottom: 10px;
  margin-bottom: 30px;
  color: #212529;
  cursor: pointer; 
}
h2 {
  font-size: 20px; 
  margin-top: 30px; 
  margin-bottom: 15px; 
  font-weight: 600;
  color: var(--primary-color);
  cursor: pointer; 
}

table { 
  border-collapse: collapse; 
  margin-bottom: 25px; 
  width: 100%; 
  table-layout: fixed; 
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
  background-color: white;
}

/* âš ï¸ ãƒ˜ãƒƒãƒ€ãƒ¼(th)ã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ã“ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ */
th { 
  border: 1px solid var(--border-color);
  padding: 12px 15px; 
  background-color: white; 
  font-weight: normal; 
  color: #333; 
  position: sticky; 
  top: 0;
  z-index: 10;
  text-align: center; 
}

/* ğŸš© TDå…±é€šã‚¹ã‚¿ã‚¤ãƒ« (ä¸­å¤®æƒãˆã¨ã‚»ãƒ«ã®é«˜ã•ã®ç¶­æŒ) */
td {
  border: 1px solid var(--border-color);
  padding: 0; 
  height: 60px; /* é«˜ã•ã‚’ç¢ºä¿ */
  white-space: normal;
  word-wrap: break-word;
  position: relative; 
  
  /* â˜…â˜…â˜… å®Œç’§ãªä¸­å¤®æƒãˆã‚’å®Ÿç¾ã™ã‚‹FlexBox â˜…â˜…â˜… */
  display: flex;
  justify-content: center; 
  align-items: center; 
  
  box-sizing: border-box;
  cursor: pointer; 
  transition: background-color 0.2s, box-shadow 0.1s;
}

/* â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: é …ç›®è¡Œ(å…ƒãƒ˜ãƒƒãƒ€ãƒ¼)ã®TDã‚¹ã‚¿ã‚¤ãƒ« â˜…â˜…â˜… */
.header-row td {
    background-color: var(--header-bg); /* å°‘ã—èƒŒæ™¯è‰²ã‚’ã¤ã‘ã¦é …ç›®è¡Œã ã¨åˆ†ã‹ã‚‹ã‚ˆã†ã« */
    font-weight: bold; /* æ–‡å­—ã‚’å¤ªã */
    color: #333;
    position: sticky; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚è¿½å¾“ã™ã‚‹ */
    top: 0;
    z-index: 10;
    cursor: text; /* ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§é …ç›®åç·¨é›†ãŒã§ãã‚‹ã‚ˆã†ã« */
}
/* â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â˜…â˜…â˜… */


/* ğŸš© ã‚»ãƒ«é¸æŠæ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
td.selected-cell {
    box-shadow: 0 0 0 3px var(--primary-color) inset;
    border-color: var(--primary-color);
}

/* ğŸš© ã‚»ãƒ«å†…ã®ã‚³ãƒ³ãƒ†ãƒŠ (å†…å®¹ã‚’ä¸­å¤®ã«é…ç½®ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼) */
.cell-content-wrapper {
  box-sizing: border-box;
  width: 100%;
  height: 100%; 
  padding: 12px 15px; 
  
  display: inline-block; 
  white-space: pre-wrap !important; 
  text-align: center !important; 
}

/* ğŸš© ç·¨é›†ç”¨Inputè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.cell-input {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  box-sizing: border-box;
  border: none;
  background-color: #fffacd; 
  padding: 12px 15px;
  font-family: inherit;
  font-size: inherit;
  text-align: center !important; 
  outline: 1px solid var(--primary-color);
  z-index: 20; 
}

/* ãƒœã‚¿ãƒ³ãªã©ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.button-group {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.table-controls {
    border: 1px solid var(--border-color);
    padding: 10px;
    border-radius: 5px;
    background-color: white;
}
.global-controls {
    margin-top: 20px;
    padding: 10px 0;
}
button {
  background-color: var(--primary-color);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s;
  font-weight: 500;
}
button:hover {
  background-color: #0056b3;
}
button:active {
  transform: scale(0.98);
}
.secondary-btn {
  background-color: var(--secondary-color);
}
.secondary-btn:hover {
  background-color: #5a6268;
}

.color-btn {
    padding: 8px 10px; 
    border-radius: 5px; 
    margin-right: 5px;
    border: 2px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: transform 0.1s, box-shadow 0.1s;
}
.color-btn:hover {
    transform: scale(1.05); 
    box-shadow: 0 0 0 2px var(--primary-color);
}
.color-btn-yellow { background-color: var(--color-yellow); color: #856404; font-weight: bold;}
.color-btn-green { background-color: var(--color-green); color: #155724; font-weight: bold;}
.color-btn-red { background-color: var(--color-red); color: #721c24; font-weight: bold;}
</style>
</head>
<body>

    <h1 ondblclick="makeEditableTitle(this)">å°±è·æ´»å‹•ãƒ¡ãƒ¢</h1>

    <div class="table-container">
        <h2 ondblclick="makeEditableTitle(this)">å‹•ã„ã¦ã„ã‚‹ä¼æ¥­ (ä¸­å¤®æƒãˆé …ç›®ã®ã¿)</h2>
        <table id="active-companies-table">
            <tbody>
                <tr class="header-row">
                    <td contenteditable="true" onclick="selectCell(this)" ondblclick="makeEditable(this)">ä¼æ¥­å</td>
                    <td contenteditable="true" onclick="selectCell(this)" ondblclick="makeEditable(this)">æ¥­ç¨®</td>
                    <td contenteditable="true" onclick="selectCell(this)" ondblclick="makeEditable(this)">é¸è€ƒçŠ¶æ³</td>
                </tr>
                <tr>
                    <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td>
                    <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td>
                    <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td>
                </tr>
            </tbody>
        </table>
        <div class="button-group table-controls">
            <button onclick="addRow('active-companies-table')">è¡Œè¿½åŠ </button>
            <button onclick="deleteRow('active-companies-table')" class="secondary-btn">è¡Œå‰Šé™¤</button>
            <button onclick="addColumn('active-companies-table')">åˆ—è¿½åŠ </button>
            <button onclick="deleteColumn('active-companies-table')" class="secondary-btn">åˆ—å‰Šé™¤</button>
        </div>
    </div>

    <hr>

    <div class="table-container">
        <h2 ondblclick="makeEditableTitle(this)">æƒ…å ±åé›†ä¸­ä¼æ¥­ (ä¸­å¤®æƒãˆé …ç›®ã®ã¿)</h2>
        <table id="research-companies-table">
            <tbody>
                <tr class="header-row">
                    <td contenteditable="true" onclick="selectCell(this)" ondblclick="makeEditable(this)">ä¼æ¥­å</td>
                    <td contenteditable="true" onclick="selectCell(this)" ondblclick="makeEditable(this)">èˆˆå‘³åº¦</td>
                </tr>
                <tr>
                    <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td>
                    <td onclick="selectCell(this)" ondblclick="makeEditable(this)"></td>
                </tr>
            </tbody>
        </table>
        <div class="button-group table-controls">
            <button onclick="addRow('research-companies-table')">è¡Œè¿½åŠ </button>
            <button onclick="deleteRow('research-companies-table')" class="secondary-btn">è¡Œå‰Šé™¤</button>
            <button onclick="addColumn('research-companies-table')">åˆ—è¿½åŠ </button>
            <button onclick="deleteColumn('research-companies-table')" class="secondary-btn">åˆ—å‰Šé™¤</button>
        </div>
    </div>

    <hr>

    <div class="button-group global-controls">
        <span>**ã‚»ãƒ«ã«è‰²ã‚’ä»˜ã‘ã‚‹:**</span>
        <button class="color-btn color-btn-yellow" onclick="applyColor('var(--color-yellow)')" title="ã‚¤ã‚¨ãƒ­ãƒ¼">é»„è‰²</button>
        <button class="color-btn color-btn-green" onclick="applyColor('var(--color-green)')" title="ã‚°ãƒªãƒ¼ãƒ³">ç·‘è‰²</button>
        <button class="color-btn color-btn-red" onclick="applyColor('var(--color-red)')" title="ãƒ¬ãƒƒãƒ‰">èµ¤è‰²</button>
        <button onclick="applyColor('')" class="secondary-btn">è‰²ã‚’ã‚¯ãƒªã‚¢</button>
        
        <hr style="width: 100%; border: none; border-bottom: 1px dashed #ccc; margin: 10px 0;">

        <button onclick="saveData()">ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (ãƒ–ãƒ©ã‚¦ã‚¶)</button>
        <button onclick="exportCSV()" class="secondary-btn">CSVã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <input type="file" id="csv-file-input" accept=".csv" style="display:none;" onchange="importCSV(event)">
        <button onclick="document.getElementById('csv-file-input').click()" class="secondary-btn">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button onclick="resetAll()">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

<script>
let selectedCell = null;

// ------------------------------------
// ğŸš© 1. ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®šç¾©ã‚’ã€Œæœ€åˆã®è¡Œã€ã«å¤‰æ›´
// ------------------------------------

function getHeaderRow(tableId) {
    const table = document.getElementById(tableId);
    // TBODYã®æœ€åˆã®è¡Œã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦æ‰±ã†
    if (table && table.tBodies.length > 0 && table.tBodies[0].rows.length > 0) {
        return table.tBodies[0].rows[0];
    }
    return null;
}

function getTableHeadCells(tableId) {
    const headerRow = getHeaderRow(tableId);
    return headerRow ? headerRow.cells : [];
}

// ------------------------------------
// ğŸš© 2. ã‚»ãƒ«å†…å®¹æ“ä½œé–¢æ•°
// ------------------------------------

function wrapContent(cell, text = '') {
    let wrapper = cell.querySelector('.cell-content-wrapper');
    
    if (!wrapper) { 
        wrapper = document.createElement('div');
        wrapper.className = 'cell-content-wrapper';
        
        const existingText = cell.textContent.trim();
        cell.textContent = ''; 
        
        cell.appendChild(wrapper);
        wrapper.innerText = text || existingText; 
    } else {
        wrapper.innerText = text;
    }
    wrapper.style.display = 'inline-block';
}

function getCellText(cell) {
    const wrapper = cell.querySelector('.cell-content-wrapper');
    return wrapper ? wrapper.innerText : '';
}

function setCellText(cell, text) {
    const wrapper = cell.querySelector('.cell-content-wrapper');
    if (wrapper) {
        wrapper.innerText = text;
        wrapper.style.display = 'inline-block'; 
    } else {
        wrapContent(cell, text);
    }
}

// ------------------------------------
// ğŸš© 3. ã‚»ãƒ«é¸æŠãƒ»ç·¨é›†é–¢é€£ (ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†)
// ------------------------------------

function selectCell(cell) {
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚»ãƒ«ã¯é¸æŠå¯¾è±¡ã‹ã‚‰é™¤å¤–ï¼ˆè‰²ä»˜ã‘ã¯å¯èƒ½ã«ã™ã‚‹ãŸã‚ï¼‰
    if (cell.closest('.header-row')) {
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ãƒ«ã¯ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹ã‹ã€è‰²ä»˜ã‘ã®å¯¾è±¡ã«ãªã‚‹
        // é¸æŠçŠ¶æ…‹ã¯é€šå¸¸ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ«ã¨åŒºåˆ¥ã™ã‚‹
    }
    
    if (cell.querySelector('input.cell-input')) return; 

    if (selectedCell) {
        selectedCell.classList.remove('selected-cell');
    }
    
    if (selectedCell !== cell) {
        cell.classList.add('selected-cell');
        selectedCell = cell;
    } else {
        selectedCell = null;
    }
}

function applyColor(colorVariable) {
    if (!selectedCell) {
        alert("è‰²ã‚’å¤‰æ›´ã—ãŸã„ã‚»ãƒ«ã‚’ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
    }
    
    const color = colorVariable ? getComputedStyle(document.documentElement).getPropertyValue(colorVariable.replace('var(', '').replace(')', '')) : '';
    
    selectedCell.style.backgroundColor = color;
    
    selectedCell.classList.remove('selected-cell');
    selectedCell = null;

    alert(`ã‚»ãƒ«ã®è‰²ã‚’${color === '' ? 'ã‚¯ãƒªã‚¢' : color}ã«è¨­å®šã—ã¾ã—ãŸã€‚å¿˜ã‚Œãšã«ã€Œãƒ‡ãƒ¼ã‚¿ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`);
}

function makeEditable(cell) {
    if (cell.querySelector('input')) return; 
    
    if (selectedCell === cell) {
        cell.classList.remove('selected-cell');
        selectedCell = null;
    }

    const originalText = getCellText(cell);
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-input';
    input.value = originalText;
    
    input.onblur = function() {
        const newText = this.value;
        const parentCell = this.parentElement;
        setCellText(parentCell, newText);
        this.remove(); 
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ãƒ«ã ã£ãŸå ´åˆã€contenteditableã‚’å¾©å…ƒ
        if (parentCell.closest('.header-row')) {
             parentCell.setAttribute('contenteditable', 'true');
        }
    };

    input.onkeydown = function(e) {
        if (e.key === 'Enter') {
            this.blur();
        }
    };
    
    const wrapper = cell.querySelector('.cell-content-wrapper');
    if(wrapper) wrapper.style.display = 'none';
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ãƒ«ã ã£ãŸå ´åˆã€contenteditableã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    if (cell.closest('.header-row')) {
        cell.removeAttribute('contenteditable');
    }

    cell.appendChild(input);
    input.focus(); 
}

// ------------------------------------
// 4. ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œé–¢æ•°
// ------------------------------------

function getTableBody(tableId) {
    return document.getElementById(tableId).tBodies[0];
}
const decodeCSVLine = (line) => {
  const cells = line.match(/(?:"[^"]*?"|[^,]+)/g) || [];
  return cells.map(c => c.replace(/^"|"$/g,'').replace(/""/g,'"').trim());
};

function makeEditableTitle(element) {
    if (element.querySelector('input')) return;
    const originalText = element.innerText;
    element.innerText = '';
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'text-input';
    input.value = originalText;
    input.onblur = function() {
        element.innerText = this.value;
        this.remove();
    };
    input.onkeydown = function(e) {
        if (e.key === 'Enter') {
            this.blur();
        }
    };
    element.appendChild(input);
    input.focus();
}

function addRow(tableId){
  const table = document.getElementById(tableId);
  let tbody = table.tBodies[0];
  if (!tbody) { tbody = table.createTBody(); }

  const headCells = getTableHeadCells(tableId);
  const cols = headCells.length;
  
  if (cols === 0) { alert("å…ˆã«é …ç›®ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚"); return; }

  const row = tbody.insertRow(-1); // å¸¸ã«æœ€å¾Œã«è¿½åŠ 
  
  for(let i=0; i<cols; i++){ 
    const cell=row.insertCell(); 
    cell.onclick = function() { selectCell(this); }; 
    cell.ondblclick = function() { makeEditable(this); }; 
    wrapContent(cell); 
  }
}

function deleteRow(tableId){
  const tbody = getTableBody(tableId);
  if (!tbody) return; 
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ(rows[0])ã¯å‰Šé™¤ã—ãªã„
  if(tbody.rows.length > 2) {
    tbody.deleteRow(-1);
  } else if (tbody.rows.length === 2) {
    // é …ç›®è¡Œã¨ãƒ‡ãƒ¼ã‚¿è¡ŒãŒ1è¡Œãšã¤ã®å ´åˆã€ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ã‚¯ãƒªã‚¢
    Array.from(tbody.rows[1].cells).forEach(cell => {
        setCellText(cell, '');
        cell.style.backgroundColor = ''; 
    });
  } else if (tbody.rows.length === 1) {
      alert("é …ç›®è¡Œã®ã¿ãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿è¡Œã‚’å¢—ã‚„ã™å ´åˆã¯ã€Œè¡Œè¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
  }
}

function addColumn(tableId){
  const table = document.getElementById(tableId);
  let tbody = table.tBodies[0];
  if (!tbody) { tbody = table.createTBody(); }
  
  // é …ç›®è¡Œã®ã‚»ãƒ«ã‚’è¿½åŠ 
  const headerRow = getHeaderRow(tableId);
  if (headerRow) {
      const headerCell = headerRow.insertCell(); 
      headerCell.setAttribute('contenteditable', 'true');
      headerCell.onclick = function() { selectCell(this); }; 
      headerCell.ondblclick = function() { makeEditable(this); }; 
      wrapContent(headerCell, 'æ–°è¦é …ç›®');
  }

  // ãƒ‡ãƒ¼ã‚¿è¡Œã®ã‚»ãƒ«ã‚’è¿½åŠ 
  // é …ç›®è¡Œ(rows[0])ã‚’é™¤ã„ã¦ãƒ«ãƒ¼ãƒ—
  for(let i=1; i<tbody.rows.length; i++){ 
    const row = tbody.rows[i];
    const cell=row.insertCell(); 
    cell.onclick = function() { selectCell(this); }; 
    cell.ondblclick = function() { makeEditable(this); }; 
    wrapContent(cell);
  }
  
  // é …ç›®è¡Œã—ã‹ãªã„å ´åˆã€ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è‡ªå‹•ã§1è¡Œè¿½åŠ 
  if (tbody.rows.length === 1) {
      const row = tbody.insertRow();
      for (let i = 0; i < getTableHeadCells(tableId).length; i++) {
        const cell = row.insertCell(); 
        cell.onclick = function() { selectCell(this); }; 
        cell.ondblclick = function() { makeEditable(this); }; 
        wrapContent(cell);
      }
  }
}

function deleteColumn(tableId){
  const table = document.getElementById(tableId);
  const tbody = table.tBodies[0];
  const headCells = getTableHeadCells(tableId);
  
  if(headCells.length > 1){ 
    // é …ç›®è¡Œã‹ã‚‰æœ€å¾Œã®ã‚»ãƒ«ã‚’å‰Šé™¤
    const headerRow = getHeaderRow(tableId);
    if (headerRow) {
        headerRow.deleteCell(-1);
    }
    
    // ãƒ‡ãƒ¼ã‚¿è¡Œã‹ã‚‰æœ€å¾Œã®ã‚»ãƒ«ã‚’å‰Šé™¤
    if (tbody) {
        for(let i=1; i<tbody.rows.length; i++) { // é …ç›®è¡Œ(rows[0])ã‚’é™¤ã„ã¦ãƒ«ãƒ¼ãƒ—
          if (tbody.rows[i].cells.length > 0) {
            tbody.rows[i].deleteCell(-1); 
          }
        }
    }
  } else {
      alert("æœ€å¾Œã®åˆ—ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
  }
}

// ------------------------------------
// 5. ãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢æ•° (saveData, resetAll)
// ------------------------------------

function resetAll(){
    document.querySelector('h1').innerText = "å°±è·æ´»å‹•ãƒ¡ãƒ¢";
    document.querySelector('.table-container:nth-of-type(1) h2').innerText = "å‹•ã„ã¦ã„ã‚‹ä¼æ¥­ (ä¸­å¤®æƒãˆé …ç›®ã®ã¿)";
    document.querySelector('.table-container:nth-of-type(2) h2').innerText = "æƒ…å ±åé›†ä¸­ä¼æ¥­ (ä¸­å¤®æƒãˆé …ç›®ã®ã¿)";

    const defaultHeaders = {
        'active-companies-table': ['ä¼æ¥­å', 'æ¥­ç¨®', 'é¸è€ƒçŠ¶æ³'],
        'research-companies-table': ['ä¼æ¥­å', 'èˆˆå‘³åº¦']
    };

    ['active-companies-table','research-companies-table'].forEach(id => {
        const table = document.getElementById(id);
        
        let tbody = table.tBodies[0];
        if (!tbody) { tbody = table.createTBody(); }
        tbody.innerHTML = '';
        
        const headerCount = defaultHeaders[id].length;

        // 1. é …ç›®è¡Œã‚’ä½œæˆ (æœ€åˆã®è¡Œ)
        const headerRow = tbody.insertRow(0);
        headerRow.classList.add('header-row');
        defaultHeaders[id].forEach(headerText => {
            const cell = headerRow.insertCell(); 
            cell.setAttribute('contenteditable', 'true');
            cell.onclick = function() { selectCell(this); }; 
            cell.ondblclick = function() { makeEditable(this); }; 
            wrapContent(cell, headerText); 
        });
        
        // 2. æœ€åˆã®ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ä½œæˆ
        const dataRow = tbody.insertRow(1);
        for (let i = 0; i < headerCount; i++) {
            const cell = dataRow.insertCell(); 
            cell.onclick = function() { selectCell(this); }; 
            cell.ondblclick = function() { makeEditable(this); }; 
            wrapContent(cell); 
        }
    });
    localStorage.removeItem('tableData'); 
    alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸã€‚");
}

function saveData(){
  const data={};
  data['texts']=[document.querySelector('h1').innerText, ...Array.from(document.querySelectorAll('h2')).map(h=>h.innerText)];
  
  const tableIds = ['active-companies-table', 'research-companies-table'];

  tableIds.forEach((id,index)=>{
    const table=document.getElementById(id);
    const rows=[];
    
    const tbody = table.tBodies[0];
    if (tbody) {
        for(let i=0; i<tbody.rows.length; i++){
          const row = tbody.rows[i];
          const cells=[];
          const cellColors=[]; 
          for(let cell of row.cells) {
              cells.push(getCellText(cell)); 
              cellColors.push(cell.style.backgroundColor || ''); 
          }
          // æœ€åˆã®è¡Œã¯ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé …ç›®åï¼‰ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã†
          if (i === 0) {
              rows.push(cells);
          } else {
              rows.push({ data: cells, colors: cellColors }); 
          }
        }
    }
    data['table'+(index+1)]=rows; 
  });
  localStorage.setItem('tableData',JSON.stringify(data));
  alert("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸï¼");
}

window.onload=()=>{
  const saved=localStorage.getItem('tableData');
  
  document.querySelector('h1').ondblclick = function() { makeEditableTitle(this); };
  document.querySelectorAll('h2').forEach(h => {
    h.ondblclick = function() { makeEditableTitle(this); };
  });

  if(saved){
    const data=JSON.parse(saved);
    const texts=[document.querySelector('h1'), ...document.querySelectorAll('h2')];
    data.texts.forEach((txt,i)=>{ 
        if(texts[i]) texts[i].innerText=txt; 
    });
    
    const tableIds = ['active-companies-table', 'research-companies-table'];
    
    tableIds.forEach((id,index)=>{
      const table=document.getElementById(id);
      let tbody = table.tBodies[0];
      if (!tbody) { tbody = table.createTBody(); }
      tbody.innerHTML = '';
      
      const allRows=data['table'+(index+1)]; 
      if (!allRows || allRows.length === 0) return;

      const headerData = allRows[0] || [];
      const dataRows = allRows.slice(1);
      
      // 1. é …ç›®è¡Œã‚’ä½œæˆ
      const headerRow = tbody.insertRow(0);
      headerRow.classList.add('header-row');
      headerData.forEach(val => {
          const cell = headerRow.insertCell(); 
          cell.setAttribute('contenteditable', 'true');
          cell.onclick = function() { selectCell(this); }; 
          cell.ondblclick = function() { makeEditable(this); }; 
          setCellText(cell, val); 
      });

      // 2. ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ä½œæˆ
      dataRows.forEach(rowDataObj => {
          const row = tbody.insertRow();
          rowDataObj.data.forEach((cellVal, i) => { 
              const cell = row.insertCell(); 
              cell.onclick = function() { selectCell(this); }; 
              cell.ondblclick = function() { makeEditable(this); }; 

              if (rowDataObj.colors && rowDataObj.colors[i]) {
                  cell.style.backgroundColor = rowDataObj.colors[i];
              }
              
              setCellText(cell, cellVal); 
          });
      });

      // ãƒ‡ãƒ¼ã‚¿è¡ŒãŒ0è¡Œã®å ´åˆã€ç©ºã®ãƒ‡ãƒ¼ã‚¿è¡Œã‚’1è¡Œè¿½åŠ 
      if (dataRows.length === 0 && headerData.length > 0) {
        const row = tbody.insertRow();
        headerData.forEach(() => { 
            const cell = row.insertCell(); 
            cell.onclick = function() { selectCell(this); }; 
            cell.ondblclick = function() { makeEditable(this); }; 
            wrapContent(cell); 
        });
      }
    });
  }

  // â˜…â˜…â˜… æœ€çµ‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†: å…¨ã¦ã®ã‚»ãƒ«ã‚’å†ç¢ºèªã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã¨ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ç¢ºå®Ÿã«è¨­å®š â˜…â˜…â˜…
  document.querySelectorAll('tbody td').forEach(cell => {
      // ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚»ãƒ«ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
      cell.onclick = function() { selectCell(this); }; 
      cell.ondblclick = function() { makeEditable(this); };
      // wrapContentã‚’å‘¼ã³å‡ºã—ã€ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã‚‚ãƒ©ãƒƒãƒ‘ãƒ¼ã®è¡¨ç¤ºã‚’å¼·åˆ¶
      wrapContent(cell, getCellText(cell)); 
  });
}

// ------------------------------------
// 6. CSVæ“ä½œé–¢æ•° 
// ------------------------------------
function exportCSV(){
  let csv='"'+document.querySelector('h1').innerText.replace(/"/g,'""')+'"\n\n';
  const h2s=document.querySelectorAll('h2');
  
  h2s.forEach((h,index)=>{
    csv+='"'+h.innerText.replace(/"/g,'""')+'"\n';
    const tableId = index === 0 ? 'active-companies-table' : 'research-companies-table';
    
    if (index === 1) {
        csv += '\n'; 
    }

    // é …ç›®è¡Œã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦æŠ½å‡º
    const headerCells = Array.from(getTableHeadCells(tableId)).map(cell => getCellText(cell).replace(/"/g,'""'));
    csv+='"' + headerCells.join('","') + '"\n';

    const tbody = getTableBody(tableId);
    if (tbody) {
        // é …ç›®è¡Œ(rows[0])ã‚’é™¤ã„ã¦ãƒ«ãƒ¼ãƒ—
        for(let i=1; i<tbody.rows.length; i++){
          const row = tbody.rows[i];
          let cells=[];
          for(let cell of row.cells) cells.push(getCellText(cell).replace(/"/g,'""'));
          csv+='"' + cells.join('","') + '"\n';
        }
    }
    csv+='\n';
  });
  const blob=new Blob(['\ufeff', csv],{type:'text/csv;charset=utf-8'}); 
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='job_search_memo.csv'; a.click();
}

// 7. CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢æ•° 
function importCSV(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  
  reader.onload=e=>{
    const lines=e.target.result.replace(/\ufeff/g, "").split('\n').map(l=>l.trim()).filter(l=>l!=='');
    if(lines.length<1) return;
    
    let tableIndex=-1, lineIndex=1; 
    const h2s=document.querySelectorAll('h2');
    const tableIds = ['active-companies-table', 'research-companies-table'];
    
    if (lines[0]) {
        document.querySelector('h1').innerText = decodeCSVLine(lines[0])[0] || "å°±è·æ´»å‹•ãƒ¡ãƒ¢";
        lineIndex++;
    }

    while (lineIndex < lines.length && lines[lineIndex].trim() === '') {
        lineIndex++;
    }

    while(lineIndex < lines.length && tableIndex < 2){
      tableIndex++;
      const table = document.getElementById(tableIds[tableIndex]);

      if(h2s[tableIndex] && lines[lineIndex]) {
          const decodedLine = decodeCSVLine(lines[lineIndex]);
          if (decodedLine.length === 1 && decodedLine[0] !== "") {
              h2s[tableIndex].innerText = decodedLine[0];
              lineIndex++; 
          }
      }
      
      while (lineIndex < lines.length && lines[lineIndex].trim() === '') {
          lineIndex++;
      }
      
      let tbody = table.tBodies[0];
      if (!tbody) { tbody = table.createTBody(); }
      tbody.innerHTML = '';
      
      let headerCells = [];
      if(lineIndex < lines.length && lines[lineIndex]) {
          headerCells = decodeCSVLine(lines[lineIndex]);
          lineIndex++; 
      }
      
      const expectedCols = headerCells.length;

      // 1. é …ç›®è¡Œã‚’ä½œæˆ (CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ ¼ç´)
      if (expectedCols > 0) {
          const headerRow = tbody.insertRow(0);
          headerRow.classList.add('header-row');
          for (let i = 0; i < expectedCols; i++) {
              const cell = headerRow.insertCell(); 
              cell.setAttribute('contenteditable', 'true');
              cell.onclick = function() { selectCell(this); }; 
              cell.ondblclick = function() { makeEditable(this); }; 
              setCellText(cell, headerCells[i] ? headerCells[i] : ''); 
          }
      }


      // 2. ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ä½œæˆ
      while(lineIndex < lines.length && lines[lineIndex]){
        const rowCells = decodeCSVLine(lines[lineIndex]);
        
        if (rowCells.length === 1 && rowCells[0] !== "") {
            break; 
        }
        if (lines[lineIndex].trim() === '') {
            break;
        }

        const row = tbody.insertRow();
        for (let i = 0; i < expectedCols; i++) {
            const cell = row.insertCell(); 
            const cellVal = rowCells[i] ? rowCells[i] : ''; 
            
            cell.onclick = function() { selectCell(this); }; 
            cell.ondblclick = function() { makeEditable(this); }; 
            setCellText(cell, cellVal); 
        }
        lineIndex++;
      }
      
      // ãƒ‡ãƒ¼ã‚¿è¡ŒãŒ0è¡Œã®å ´åˆã€ç©ºã®ãƒ‡ãƒ¼ã‚¿è¡Œã‚’1è¡Œè¿½åŠ  (é …ç›®è¡ŒãŒã‚ã‚‹å ´åˆã®ã¿)
      if (tbody.rows.length === 1 && expectedCols > 0) {
        const row = tbody.insertRow();
        for (let i = 0; i < expectedCols; i++) {
            const cell = row.insertCell(); 
            cell.onclick = function() { selectCell(this); }; 
            cell.ondblclick = function() { makeEditable(this); }; 
            wrapContent(cell); 
        }
      }
      
      lineIndex++; 
    }
    alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼");
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
