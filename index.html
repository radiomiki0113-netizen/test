<script>
// --- JS関数の修正版 ---

// ヘッダーセルとTbodyを取得する補助関数はそのまま
function getTableHeadCells(tableId) {
    // ヘッダー行が存在しない場合の安全策を追加
    const table = document.getElementById(tableId);
    if (table && table.tHead && table.tHead.rows.length > 0) {
        return table.tHead.rows[0].cells;
    }
    return [];
}
function getTableBody(tableId) {
    return document.getElementById(tableId).tBodies[0];
}

// 行追加の修正
function addRow(tableId){
  const tbody = getTableBody(tableId);
  const headCells = getTableHeadCells(tableId);
  const cols = headCells.length;
  
  if (cols === 0) {
      alert("先に列（ヘッダー）を追加してください。");
      return; 
  }

  const row = tbody.insertRow();
  for(let i=0; i<cols; i++){ 
    const cell=row.insertCell(); 
    cell.contentEditable="true"; 
  }
}

// 行削除の修正 (変更なし、問題なしと判断)
function removeRow(tableId){
  const tbody = getTableBody(tableId);
  if(tbody.rows.length > 1) {
    tbody.deleteRow(-1);
  } else {
    // 1行しか残っていない場合は内容をクリア
    if (tbody.rows.length === 1) {
        Array.from(tbody.rows[0].cells).forEach(cell => cell.innerText = '');
    }
  }
}

// 列追加の修正 (変更なし、問題なしと判断)
function addCol(tableId){
  const tbody = getTableBody(tableId);
  const ths = getTableHeadCells(tableId)[0].parentNode; // tHead.rows[0]
  
  const th = document.createElement('th'); 
  th.innerText = `新規列`;
  th.contentEditable="true"; 
  ths.appendChild(th);
  
  for(let row of tbody.rows){ 
    const cell=row.insertCell(); 
    cell.contentEditable="true"; 
  }
}

// 列削除の修正 (変更なし、問題なしと判断)
function removeCol(tableId){
  const tbody = getTableBody(tableId);
  const ths = getTableHeadCells(tableId);
  
  if(ths.length > 1){ 
    ths[ths.length - 1].remove(); 
    for(let row of tbody.rows) {
      if (row.cells.length > 0) {
        row.deleteCell(-1); 
      }
    }
  } else {
      alert("最後の列は削除できません。");
  }
}

// resetTablesの修正 (デフォルトのヘッダー再設定を確実に行うように調整)
function resetTables(){
  document.querySelector('h1').innerText = "就職活動 メモ";
  const defaultHeaders = {
    'table1': ['企業名', '業種', '選考状況', '次回予定'],
    'table2': ['企業名', '興味度', '備考', '情報源']
  };

  document.querySelector('h3:nth-of-type(1)').innerText = "動いている企業";
  document.querySelector('h3:nth-of-type(2)').innerText = "情報収集中の企業";

  ['table1','table2'].forEach(id => {
    const table = document.getElementById(id);
    // ヘッダー行が存在しない場合に備えて作成
    if (!table.tHead || table.tHead.rows.length === 0) {
      if (!table.tHead) table.createTHead();
      table.tHead.insertRow();
    }
    const tHeadRow = table.tHead.rows[0];
    const tbody = table.tBodies[0];
    
    // ヘッダーを初期化
    tHeadRow.innerHTML = '';
    defaultHeaders[id].forEach(headerText => {
      const th = document.createElement('th');
      th.contentEditable = "true";
      th.innerText = headerText;
      tHeadRow.appendChild(th);
    });

    // データ行を初期化
    tbody.innerHTML = '';
    const row = tbody.insertRow();
    defaultHeaders[id].forEach(() => {
        const cell = row.insertCell(); 
        cell.contentEditable = "true"; 
    });
  });
  localStorage.removeItem('tableData'); 
  alert("テーブルとローカル保存データをリセットしました！");
}

// saveTables以降の関数は前回の改良版で正常動作すると考えられますので、そのまま利用します。

function saveTables(){
  const data={};
  data['texts']=[document.querySelector('h1').innerText, ...Array.from(document.querySelectorAll('h3')).map(h=>h.innerText)];
  
  ['table1','table2'].forEach((id,index)=>{
    const table=document.getElementById(id);
    const rows=[];
    const headerCells = Array.from(table.tHead.rows[0].cells).map(cell => cell.innerText);
    rows.push(headerCells);

    for(let row of table.tBodies[0].rows){
      const cells=[];
      for(let cell of row.cells) cells.push(cell.innerText);
      rows.push(cells);
    }
    data['table'+(index+1)]=rows;
  });
  localStorage.setItem('tableData',JSON.stringify(data));
  alert("データをブラウザに保存しました！");
}

window.onload=()=>{
  const saved=localStorage.getItem('tableData');
  if(saved){
    const data=JSON.parse(saved);
    const texts=[document.querySelector('h1'), ...document.querySelectorAll('h3')];
    data.texts.forEach((txt,i)=>{ if(texts[i]) texts[i].innerText=txt; });
    
    ['table1','table2'].forEach((id,index)=>{
      const table=document.getElementById(id);
      
      // tHeadが存在しない場合の対処
      if (!table.tHead || table.tHead.rows.length === 0) {
        if (!table.tHead) table.createTHead();
        table.tHead.insertRow();
      }
      const tHeadRow=table.tHead.rows[0];
      const tbody=table.tBodies[0];
      const allRows=data['table'+(index+1)]; 

      // 1. ヘッダーの復元
      const headerData = allRows[0] || [];
      tHeadRow.innerHTML = '';
      headerData.forEach(val => {
        const th = document.createElement('th');
        th.contentEditable = "true";
        th.innerText = val;
        tHeadRow.appendChild(th);
      });

      // 2. データ行の復元
      const dataRows = allRows.slice(1);
      tbody.innerHTML = '';
      
      dataRows.forEach(rowData => {
          const row = tbody.insertRow();
          rowData.forEach(cellVal => { 
              const cell = row.insertCell(); 
              cell.contentEditable="true"; 
              cell.innerText = cellVal; 
          });
      });

      if (tbody.rows.length === 0 && headerData.length > 0) {
        const row = tbody.insertRow();
        headerData.forEach(() => { 
            const cell = row.insertCell(); 
            cell.contentEditable="true"; 
        });
      }
    });
  }
}

function exportCSV(){
  let csv='"'+document.querySelector('h1').innerText.replace(/"/g,'""')+'"\n\n';
  const h3s=document.querySelectorAll('h3');
  h3s.forEach((h,index)=>{
    csv+='"'+h.innerText.replace(/"/g,'""')+'"\n';
    const table=document.getElementById('table'+(index+1));
    
    const headerCells = Array.from(table.tHead.rows[0].cells).map(cell => cell.innerText.replace(/"/g,'""'));
    csv+='"' + headerCells.join('","') + '"\n';

    for(let row of table.tBodies[0].rows){
      let cells=[];
      for(let cell of row.cells) cells.push(cell.innerText.replace(/"/g,'""'));
      csv+='"' + cells.join('","') + '"\n';
    }
    csv+='\n';
  });
  const blob=new Blob(['\ufeff', csv],{type:'text/csv;charset=utf-8'}); 
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='job_search_memo.csv'; a.click();
}

function importCSV(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.replace(/\ufeff/g, "").split('\n').map(l=>l.trim()).filter(l=>l!=='');
    if(lines.length<1) return;
    
    document.querySelector('h1').innerText=lines[0].
