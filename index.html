<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>エクセルみたいな表</title>
  <style>
    table { border-collapse: collapse; margin: 10px 0; }
    th, td { border: 1px solid #ccc; padding: 5px; min-width: 80px; }
    th { background: #eee; }
    td { background: #fcfcf5; }
    button, label[for="csvFileInput"] {
      margin: 5px;
      padding: 5px 10px;
      border: 1px solid #888;
      border-radius: 4px;
      background: #f0f0f0;
      cursor: pointer;
    }
    input[type="file"] {
      display: none; /* 本来のファイル選択を隠す */
    }
  </style>
</head>
<body>
  <h2>エクセルみたいな表（ブラウザ保存＋CSV入出力＋列追加）</h2>
  <table id="sheet">
    <thead>
      <tr id="header">
        <th>A</th>
        <th>B</th>
        <th>C</th>
        <th>D</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
      </tr>
    </tbody>
  </table>

  <button onclick="addRow()">行を追加</button>
  <button onclick="addColumn()">列を追加</button>
  <button onclick="saveTable()">保存</button>
  <button onclick="downloadCSV()">CSVとして保存</button>

  <!-- 見た目はボタンだけど、裏でinput[type=file]を呼ぶ -->
  <label for="csvFileInput">CSVを読み込む</label>
  <input type="file" id="csvFileInput" accept=".csv" onchange="uploadCSV(event)">
  
  <button onclick="resetTable()">リセット</button>

  <script>
    const table = document.getElementById("sheet").getElementsByTagName("tbody")[0];
    const header = document.getElementById("header");

    // 行追加
    function addRow() {
      let row = table.insertRow();
      for (let i = 0; i < header.cells.length; i++) {
        let cell = row.insertCell();
        cell.contentEditable = "true";
      }
    }

    // 列追加
    function addColumn() {
      let colIndex = header.cells.length;
      let colName = String.fromCharCode(65 + colIndex); // A=65
      let th = document.createElement("th");
      th.textContent = colName;
      header.appendChild(th);

      for (let i = 0; i < table.rows.length; i++) {
        let cell = table.rows[i].insertCell();
        cell.contentEditable = "true";
      }
    }

    // 保存（localStorage）
    function saveTable() {
      let data = [];
      for (let r = 0; r < table.rows.length; r++) {
        let row = [];
        for (let c = 0; c < table.rows[r].cells.length; c++) {
          row.push(table.rows[r].cells[c].innerText);
        }
        data.push(row);
      }
      localStorage.setItem("myTable", JSON.stringify(data));
      alert("保存しました！");
    }

    // 読み込み
    window.onload = function() {
      let data = JSON.parse(localStorage.getItem("myTable") || "[]");
      if (data.length > 0) {
        table.innerHTML = "";
        data.forEach(r => {
          let row = table.insertRow();
          r.forEach(val => {
            let cell = row.insertCell();
            cell.contentEditable = "true";
            cell.innerText = val;
          });
        });
      }
    }

    // CSV保存
    function downloadCSV() {
      let csv = [];
      for (let r = 0; r < table.rows.length; r++) {
        let row = [];
        for (let c = 0; c < table.rows[r].cells.length; c++) {
          row.push('"' + table.rows[r].cells[c].innerText.replace(/"/g, '""') + '"');
        }
        csv.push(row.join(","));
      }
      let blob = new Blob([csv.join("\n")], { type: "text/csv" });
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "table.csv";
      link.click();
    }

    // CSV読み込み
    function uploadCSV(event) {
      let file = event.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(e) {
        let rows = e.target.result.split("\n").map(r => r.split(","));
        table.innerHTML = "";
        rows.forEach(r => {
          let row = table.insertRow();
          r.forEach(val => {
            let cell = row.insertCell();
            cell.contentEditable = "true";
            cell.innerText = val.replace(/^"|"$/g, '').replace(/""/g, '"');
          });
        });
      };
      reader.readAsText(file);
    }

    // リセット
    function resetTable() {
      table.innerHTML = "<tr><td contenteditable='true'></td><td contenteditable='true'></td><td contenteditable='true'></td><td contenteditable='true'></td></tr>";
      localStorage.removeItem("myTable");
    }
  </script>
</body>
</html>